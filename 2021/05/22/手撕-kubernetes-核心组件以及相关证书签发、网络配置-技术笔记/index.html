<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">






  <meta name="keywords" content="K8S,kubernetes,软件安装," />










<meta name="description" content="系统：Windows10 专业版 安装虚拟机软件VMwareWorkstation 16 Pro for Windows:  https:&#x2F;&#x2F;www.vmware.com&#x2F;go&#x2F;getworkstation-win 序列号：ZF3R0-FHED2-M80TY-8QYGC-NPKYF 创建准备Linux虚拟机环境下载系统镜像Centos7： http:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ce">
<meta property="og:type" content="article">
<meta property="og:title" content="手撕 kubernetes 核心组件以及相关证书签发、网络配置 技术笔记">
<meta property="og:url" content="http://blog.darifo.xyz/2021/05/22/%E6%89%8B%E6%92%95-kubernetes-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%8F%91%E3%80%81%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE-%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Darifo&#39;s Blog">
<meta property="og:description" content="系统：Windows10 专业版 安装虚拟机软件VMwareWorkstation 16 Pro for Windows:  https:&#x2F;&#x2F;www.vmware.com&#x2F;go&#x2F;getworkstation-win 序列号：ZF3R0-FHED2-M80TY-8QYGC-NPKYF 创建准备Linux虚拟机环境下载系统镜像Centos7： http:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ce">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-05-21T17:35:03.000Z">
<meta property="article:modified_time" content="2021-05-21T17:35:03.000Z">
<meta property="article:author" content="Darifo">
<meta property="article:tag" content="K8S">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="软件安装">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.darifo.xyz/2021/05/22/手撕-kubernetes-核心组件以及相关证书签发、网络配置-技术笔记/"/>





  <title>手撕 kubernetes 核心组件以及相关证书签发、网络配置 技术笔记 | Darifo's Blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Darifo's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Live to learn old, there are still many to learn. </h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.darifo.xyz/2021/05/22/%E6%89%8B%E6%92%95-kubernetes-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%8F%91%E3%80%81%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE-%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Darifo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Darifo's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">手撕 kubernetes 核心组件以及相关证书签发、网络配置 技术笔记</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-05-22T01:35:03+08:00">
                2021-05-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>系统：Windows10 专业版</p>
<h4 id="安装虚拟机软件VMware"><a href="#安装虚拟机软件VMware" class="headerlink" title="安装虚拟机软件VMware"></a>安装虚拟机软件VMware</h4><p>Workstation 16 Pro for Windows:  <a href="https://www.vmware.com/go/getworkstation-win" target="_blank" rel="noopener">https://www.vmware.com/go/getworkstation-win</a></p>
<p>序列号：ZF3R0-FHED2-M80TY-8QYGC-NPKYF</p>
<h4 id="创建准备Linux虚拟机环境"><a href="#创建准备Linux虚拟机环境" class="headerlink" title="创建准备Linux虚拟机环境"></a>创建准备Linux虚拟机环境</h4><h5 id="下载系统镜像"><a href="#下载系统镜像" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>Centos7：</p>
<p><a href="http://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso</a></p>
<p>Ubuntu20：</p>
<p><a href="https://releases.ubuntu.com/20.04/ubuntu-20.04.2-live-server-amd64.iso" target="_blank" rel="noopener">https://releases.ubuntu.com/20.04/ubuntu-20.04.2-live-server-amd64.iso</a></p>
<h5 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h5><h5 id="制作模板机"><a href="#制作模板机" class="headerlink" title="制作模板机"></a>制作模板机</h5><ul>
<li><p>修改软件镜像源地址</p>
</li>
<li><p>安装基础软件工具包（net-tools、vim、git等） </p>
</li>
<li><p>安装容器运行时docker</p>
</li>
</ul>
<h5 id="根据模板机克隆至少5个虚拟机"><a href="#根据模板机克隆至少5个虚拟机" class="headerlink" title="根据模板机克隆至少5个虚拟机"></a>根据模板机克隆至少5个虚拟机</h5><ul>
<li>运维管理节点</li>
<li>Maser主节点</li>
<li>DNS节点</li>
<li>计算节点1</li>
<li>计算节点2</li>
</ul>
<h4 id="网络规划和配置"><a href="#网络规划和配置" class="headerlink" title="网络规划和配置"></a>网络规划和配置</h4><h5 id="虚拟机网络（服务器网络）"><a href="#虚拟机网络（服务器网络）" class="headerlink" title="虚拟机网络（服务器网络）"></a>虚拟机网络（服务器网络）</h5><p>网段：10.4.7.X/24</p>
<p>子网掩码：255.255.255.0</p>
<p>网关：10.4.7.254</p>
<p>DNS服务器1：10.4.7.254</p>
<h6 id="服务器1（主节点Master）"><a href="#服务器1（主节点Master）" class="headerlink" title="服务器1（主节点Master）"></a>服务器1（主节点Master）</h6><p>IP地址：10.4.7.200</p>
<h6 id="服务器2（管理运维节点Manager）"><a href="#服务器2（管理运维节点Manager）" class="headerlink" title="服务器2（管理运维节点Manager）"></a>服务器2（管理运维节点Manager）</h6><p>IP地址：10.4.7.100</p>
<h6 id="服务器3（DNS节点）"><a href="#服务器3（DNS节点）" class="headerlink" title="服务器3（DNS节点）"></a>服务器3（DNS节点）</h6><p>IP地址：10.4.7.11</p>
<h6 id="服务器4（计算节点1）"><a href="#服务器4（计算节点1）" class="headerlink" title="服务器4（计算节点1）"></a>服务器4（计算节点1）</h6><p>IP地址：10.4.7.22</p>
<h6 id="服务器5（计算节点2）"><a href="#服务器5（计算节点2）" class="headerlink" title="服务器5（计算节点2）"></a>服务器5（计算节点2）</h6><p>IP地址：10.4.7.33</p>
<p>手动配置静态IP地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line"></span><br><span class="line">TYPE="Ethernet"</span><br><span class="line">PROXY_METHOD="none"</span><br><span class="line">BROWSER_ONLY="no"</span><br><span class="line">BOOTPROTO="static" // dhcp 自动获取 static 静态IP设置</span><br><span class="line">DEFROUTE="yes"</span><br><span class="line">IPV4_FAILURE_FATAL="no"</span><br><span class="line">IPV6INIT="yes"</span><br><span class="line">IPV6_AUTOCONF="yes"</span><br><span class="line">IPV6_DEFROUTE="yes"</span><br><span class="line">IPV6_FAILURE_FATAL="no"</span><br><span class="line">IPV6_ADDR_GEN_MODE="stable-privacy"</span><br><span class="line">NAME="ens33"</span><br><span class="line">UUID="8500e7cf-3d2e-4002-9b5b-47678d8118f9"</span><br><span class="line">DEVICE="ens33"</span><br><span class="line">ONBOOT="yes"  // 启动时自动网络连接</span><br><span class="line">IPADDR="10.4.7.200"</span><br><span class="line">GATEWAY="10.4.7.254"</span><br><span class="line">DNS1="10.4.7.254"</span><br></pre></td></tr></table></figure>

<p>查看地址信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# ip addr </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:fd:f1:b9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.4.7.200/8 brd 10.255.255.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::95e8:b37e:802a:9184/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>测试ping网络地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (14.215.177.39) 56(84) bytes of data.</span><br><span class="line">64 bytes from 14.215.177.39 (14.215.177.39): icmp_seq=1 ttl=128 time=44.2 ms</span><br><span class="line">64 bytes from 14.215.177.39 (14.215.177.39): icmp_seq=2 ttl=128 time=47.5 ms</span><br><span class="line">64 bytes from 14.215.177.39 (14.215.177.39): icmp_seq=3 ttl=128 time=40.3 ms</span><br><span class="line">^C</span><br><span class="line">--- www.a.shifen.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2012ms</span><br><span class="line">rtt min/avg/max/mdev = 40.349/44.042/47.539/2.943 ms</span><br></pre></td></tr></table></figure>

<h5 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h5><h6 id="更改主机名"><a href="#更改主机名" class="headerlink" title="更改主机名"></a>更改主机名</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@centos7demo</span> ~]<span class="meta"># vim /etc/hostname</span></span><br></pre></td></tr></table></figure>

<p>K8s官方安装解决方案：</p>
<p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker</a></p>
<h4 id="关闭防火墙-firewalld"><a href="#关闭防火墙-firewalld" class="headerlink" title="关闭防火墙 firewalld"></a>关闭防火墙 firewalld</h4><p>查看centos防火墙状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# systemctl status firewalld</span><br><span class="line"></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since 一 2021-05-17 22:46:14 CST; 19min ago</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line"> Main PID: 682 (firewalld)</span><br><span class="line">   CGroup: /system.slice/firewalld.service</span><br><span class="line">           └─682 /usr/bin/python2 -Es /usr/sbin/firewalld --nofork --nopid</span><br><span class="line"></span><br><span class="line">5月 17 22:46:14 centos7demo systemd[1]: Starting firewalld - dynamic firewall daemon...</span><br><span class="line">5月 17 22:46:14 centos7demo systemd[1]: Started firewalld - dynamic firewall daemon.</span><br><span class="line">5月 17 22:46:14 centos7demo firewalld[682]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure co... now.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br></pre></td></tr></table></figure>

<p>关闭防火墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# systemctl stop firewalld</span><br><span class="line">[root@centos7demo ~]# systemctl status firewalld</span><br><span class="line"></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead) since 一 2021-05-17 23:34:10 CST; 10s ago</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line">  Process: 682 ExecStart=/usr/sbin/firewalld --nofork --nopid $FIREWALLD_ARGS (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 682 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">5月 17 22:46:14 centos7demo systemd[1]: Starting firewalld - dynamic firewall daemon...</span><br><span class="line">5月 17 22:46:14 centos7demo systemd[1]: Started firewalld - dynamic firewall daemon.</span><br><span class="line">5月 17 22:46:14 centos7demo firewalld[682]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure co... now.</span><br><span class="line">5月 17 23:34:06 centos7demo systemd[1]: Stopping firewalld - dynamic firewall daemon...</span><br><span class="line">5月 17 23:34:10 centos7demo systemd[1]: Stopped firewalld - dynamic firewall daemon.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br></pre></td></tr></table></figure>

<p>避免开机启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# systemctl disable firewalld</span><br><span class="line"></span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br></pre></td></tr></table></figure>

<p>关于SELinux</p>
<p>SELinux 有三个模式（可以由用户设置）。这些模式将规定 SELinux 在主体请求时如何应对。</p>
<p>这些模式是：</p>
<p>Enforcing 强制— SELinux 策略强制执行，基于 SELinux 策略规则授予或拒绝主体对目标的访问</p>
<p>Permissive 宽容— SELinux 策略不强制执行，不实际拒绝访问，但会有拒绝信息写入日志</p>
<p>Disabled 禁用— 完全禁用SELinux</p>
<p>默认情况下，大部分系统的SELinux设置为Enforcing。</p>
<p>查看系统当前是什么模式？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# getenforce</span><br><span class="line"></span><br><span class="line">Enforcing</span><br></pre></td></tr></table></figure>


<h4 id="关闭SELinux"><a href="#关闭SELinux" class="headerlink" title="关闭SELinux"></a>关闭SELinux</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# vim /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># This file controls the state of SELinux on the system.</span></span><br><span class="line"><span class="comment"># SELINUX= can take one of these three values:</span></span><br><span class="line"><span class="comment">#     enforcing - SELinux security policy is enforced.</span></span><br><span class="line"><span class="comment">#     permissive - SELinux prints warnings instead of enforcing.</span></span><br><span class="line"><span class="comment">#     disabled - No SELinux policy is loaded.</span></span><br><span class="line"><span class="attribute">SELINUX</span>=disabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># SELINUXTYPE= can take one of three values:</span></span><br><span class="line"><span class="comment">#     targeted - Targeted processes are protected,</span></span><br><span class="line"><span class="comment">#     minimum - Modification of targeted policy. Only selected processes are protected. </span></span><br><span class="line"><span class="comment">#     mls - Multi Level Security protection.</span></span><br><span class="line"><span class="attribute">SELINUXTYPE</span>=targeted</span><br></pre></td></tr></table></figure>

<p>重启机器后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# sestatus -v</span><br><span class="line"></span><br><span class="line">SELinux status:                 disabled</span><br></pre></td></tr></table></figure>

<p>Linux Swap</p>
<p>swap space是磁盘上的一块区域，可以是一个分区，也可以是一个文件，或者是他们的组合。简单点说，当系统物理内存吃紧时，Linux会将内存中不常访问的数据保存到swap上，这样系统就有更多的物理内存为各个进程服务，而当系统需要访问swap上存储的内容时，再将swap上的数据加载到内存中，这就是我们常说的swap out和swap in。</p>
<p>很多发行版(如ubuntu)的休眠功能依赖于swap分区，当系统休眠的时候，会将内存中的数据保存到swap分区上，等下次系统启动的时候，再将数据加载到内存中，这样可以加快系统的启动速度，所以如果要使用休眠的功能，必须要配置swap分区，并且大小一定要大于等于物理内存。</p>
<h4 id="关闭SWAP"><a href="#关闭SWAP" class="headerlink" title="关闭SWAP"></a>关闭SWAP</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# swapoff </span><br><span class="line"></span><br><span class="line">用法：</span><br><span class="line"> swapoff [选项] [&lt;指定&gt;]</span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line"> -a, --all              禁用 /proc/swaps 中的所有交换区</span><br><span class="line"> -v, --verbose          verbose mode</span><br><span class="line"></span><br><span class="line"> -h, --help     显示此帮助并退出</span><br><span class="line"> -V, --version  输出版本信息并退出</span><br><span class="line"></span><br><span class="line"> &lt;指定&gt; 参数包括：</span><br><span class="line"> -L &lt;标签&gt;              要使用设备的标签</span><br><span class="line"> -U &lt;uuid&gt;              要使用设备的 UUID</span><br><span class="line"> LABEL=&lt;标签&gt;           要使用设备的标签</span><br><span class="line"> UUID=&lt;uuid&gt;            要使用设备的 UUID</span><br><span class="line"> &lt;设备&gt;                 要使用设备的名称</span><br><span class="line"> &lt;文件&gt;                 要使用文件的名称</span><br><span class="line"></span><br><span class="line">更多信息请参阅 swapoff(8)。</span><br></pre></td></tr></table></figure>

<h6 id="禁用-proc-swaps-中的所有交换区"><a href="#禁用-proc-swaps-中的所有交换区" class="headerlink" title="禁用 /proc/swaps 中的所有交换区"></a>禁用 /proc/swaps 中的所有交换区</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# swapoff -a</span><br></pre></td></tr></table></figure>

<h6 id="注释掉-swap-相关配置"><a href="#注释掉-swap-相关配置" class="headerlink" title="注释掉 swap 相关配置"></a>注释掉 swap 相关配置</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# vim /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/fstab</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Created by anaconda on Mon May 17 19:12:22 2021</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Accessible filesystems, by reference, are maintained under <span class="string">'/dev/disk'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) <span class="keyword">for</span> more info</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">/dev/mapper/centos-root /                       xfs     defaults        0 0</span><br><span class="line">UUID=48fe47be-026f-4654-9de9-80b019e25b1a /boot                   xfs     defaults        0 0</span><br><span class="line"><span class="meta">#</span><span class="bash">/dev/mapper/centos-swap swap                    swap    defaults        0 0</span></span><br></pre></td></tr></table></figure>

<h6 id="确保成功-列表为空"><a href="#确保成功-列表为空" class="headerlink" title="确保成功 列表为空"></a>确保成功 列表为空</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# cat /proc/swaps </span><br><span class="line"></span><br><span class="line">Filename				Type		Size	Used	Priority</span><br></pre></td></tr></table></figure>

<h4 id="安装容器运行时（Docker）"><a href="#安装容器运行时（Docker）" class="headerlink" title="安装容器运行时（Docker）"></a>安装容器运行时（Docker）</h4><h6 id="更新yum软件包"><a href="#更新yum软件包" class="headerlink" title="更新yum软件包"></a>更新yum软件包</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# yum -y update &amp;&amp; yum -y upgrade</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * extras: mirrors.bfsu.edu.cn</span><br><span class="line"> * updates: mirrors.163.com</span><br><span class="line">正在解决依赖关系</span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> 正在检查事务</span></span><br><span class="line">...</span><br><span class="line">完毕！</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * extras: mirrors.bfsu.edu.cn</span><br><span class="line"> * updates: mirrors.163.com</span><br></pre></td></tr></table></figure>

<h6 id="安装基础依赖"><a href="#安装基础依赖" class="headerlink" title="安装基础依赖"></a>安装基础依赖</h6><p>yum网络不通，导致安装软件包失败</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Downloading packages:</span><br><span class="line">wget-<span class="number">1.14</span>-<span class="number">18</span>.el7_6.<span class="number">1</span>.x86_64.rp FAILED                                          </span><br><span class="line">http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/centos/</span><span class="number">7.9</span>.<span class="number">2009</span><span class="regexp">/os/</span>x86_64<span class="regexp">/Packages/</span>wget-<span class="number">1.14</span>-<span class="number">18</span>.el7_6.<span class="number">1</span>.x86_64.rpm: [Errno <span class="number">14</span>] curl<span class="comment">#6 - "Could not resolve host: mirrors.aliyun.com; Unknown error"</span></span><br><span class="line">正在尝试其它镜像。</span><br></pre></td></tr></table></figure>

<p>解决：添加DNS</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo yum.repos.d]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line"></span><br><span class="line">TYPE="Ethernet"</span><br><span class="line">PROXY_METHOD="none"</span><br><span class="line">BROWSER_ONLY="no"</span><br><span class="line">BOOTPROTO="static"</span><br><span class="line">DEFROUTE="yes"</span><br><span class="line">IPV4_FAILURE_FATAL="no"</span><br><span class="line">IPV6INIT="yes"</span><br><span class="line">IPV6_AUTOCONF="yes"</span><br><span class="line">IPV6_DEFROUTE="yes"</span><br><span class="line">IPV6_FAILURE_FATAL="no"</span><br><span class="line">IPV6_ADDR_GEN_MODE="stable-privacy"</span><br><span class="line">NAME="ens33"</span><br><span class="line">UUID="8500e7cf-3d2e-4002-9b5b-47678d8118f9"</span><br><span class="line">DEVICE="ens33"</span><br><span class="line">ONBOOT="yes"</span><br><span class="line">IPADDR="10.4.7.200"</span><br><span class="line">GATEWAY="10.4.7.254"</span><br><span class="line">DNS1="10.4.7.254"</span><br><span class="line">DNS2="8.8.8.8"</span><br><span class="line">DNS3="114.114.114.114"</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo yum.repos.d]# systemctl restart network</span><br></pre></td></tr></table></figure>

<p>安装基础包（虚拟磁盘管理工具）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo yum.repos.d]# yum install yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * extras: mirrors.bfsu.edu.cn</span><br><span class="line"> * updates: mirrors.163.com</span><br><span class="line">软件包 device-mapper-persistent-data-0.8.5-3.el7_9.2.x86_64 已安装并且是最新版本</span><br><span class="line">软件包 7:lvm2-2.02.187-6.el7_9.5.x86_64 已安装并且是最新版本</span><br><span class="line">正在解决依赖关系</span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> 正在检查事务</span></span><br><span class="line">...</span><br><span class="line">作为依赖被安装:</span><br><span class="line">  libxml2-python.x86_64 0:2.9.1-6.el7.5     python-chardet.noarch 0:2.2.1-3.el7     python-kitchen.noarch 0:1.1.1-5.el7    </span><br><span class="line"></span><br><span class="line">完毕！</span><br></pre></td></tr></table></figure>

<h6 id="添加-Docker-yum阿里云仓库"><a href="#添加-Docker-yum阿里云仓库" class="headerlink" title="添加 Docker yum阿里云仓库"></a>添加 Docker yum阿里云仓库</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# yum-config-manager --<span class="built_in">add</span>-repo http://mirrors.aliyun.<span class="keyword">com</span>/docker-<span class="keyword">ce</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line"></span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">adding repo from: http://mirrors.aliyun.<span class="keyword">com</span>/docker-<span class="keyword">ce</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">grabbing <span class="keyword">file</span> http://mirrors.aliyun.<span class="keyword">com</span>/docker-<span class="keyword">ce</span>/linux/centos/docker-<span class="keyword">ce</span>.repo <span class="keyword">to</span> /etc/yum.repos.d/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">repo saved <span class="keyword">to</span> /etc/yum.repos.d/docker-<span class="keyword">ce</span>.repo</span><br></pre></td></tr></table></figure>

<h6 id="安装docker-ce"><a href="#安装docker-ce" class="headerlink" title="安装docker-ce"></a>安装docker-ce</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# yum update &amp;&amp; yum install docker-ce</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * extras: mirrors.bfsu.edu.cn</span><br><span class="line"> * updates: mirrors.163.com</span><br><span class="line">base                                                                                                  | 3.6 kB  00:00:00     </span><br><span class="line">docker-ce-stable                                                                                      | 3.5 kB  00:00:00     </span><br><span class="line">extras                                                                                                | 2.9 kB  00:00:00     </span><br><span class="line">updates                                                                                               | 2.9 kB  00:00:00     </span><br><span class="line">(1/2): docker-ce-stable/7/x86_64/primary_db                                                           |  60 kB  00:00:00     </span><br><span class="line">(2/2): docker-ce-stable/7/x86_64/updateinfo                                                           |   55 B  00:00:02     </span><br><span class="line">No packages marked for update</span><br><span class="line">已加载插件：fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * extras: mirrors.bfsu.edu.cn</span><br><span class="line"> * updates: mirrors.163.com</span><br><span class="line">正在解决依赖关系</span><br><span class="line"><span class="meta">--&gt;</span><span class="bash"> 正在检查事务</span></span><br><span class="line"><span class="meta">---&gt;</span><span class="bash"> 软件包 docker-ce.x86_64.3.20.10.6-3.el7 将被 安装</span></span><br><span class="line">...</span><br><span class="line">已安装:</span><br><span class="line">  docker-ce.x86_64 3:20.10.6-3.el7                                                                                           </span><br><span class="line">作为依赖被安装:</span><br><span class="line">  audit-libs-python.x86_64 0:2.8.5-4.el7                         checkpolicy.x86_64 0:2.5-8.el7                              </span><br><span class="line">  container-selinux.noarch 2:2.119.2-1.911c772.el7_8             containerd.io.x86_64 0:1.4.4-3.1.el7                        </span><br><span class="line">  docker-ce-cli.x86_64 1:20.10.6-3.el7                           docker-ce-rootless-extras.x86_64 0:20.10.6-3.el7            </span><br><span class="line">  docker-scan-plugin.x86_64 0:0.7.0-3.el7                        fuse-overlayfs.x86_64 0:0.7.2-6.el7_8                       </span><br><span class="line">  fuse3-libs.x86_64 0:3.6.1-4.el7                                libcgroup.x86_64 0:0.41-21.el7                              </span><br><span class="line">  libseccomp.x86_64 0:2.3.1-4.el7                                libsemanage-python.x86_64 0:2.5-14.el7                      </span><br><span class="line">  policycoreutils-python.x86_64 0:2.5-34.el7                     python-IPy.noarch 0:0.75-6.el7                              </span><br><span class="line">  setools-libs.x86_64 0:3.3.8-4.el7                              slirp4netns.x86_64 0:0.4.3-4.el7_8                          </span><br><span class="line"></span><br><span class="line">完毕！</span><br></pre></td></tr></table></figure>


<h6 id="配置Docker-daemon"><a href="#配置Docker-daemon" class="headerlink" title="配置Docker daemon"></a>配置Docker daemon</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo ~]# mkdir /etc/docker</span><br><span class="line">[root@centos7demo ~]# cd /etc/docker/</span><br><span class="line">[root@centos7demo docker]# vim daemon.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">  "log-driver": "json-file",</span><br><span class="line">  "log-opts": &#123;</span><br><span class="line">    "max-size": "100m"</span><br><span class="line">  &#125;,</span><br><span class="line">  "storage-driver": "overlay2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="重载配置和重启docker设置开机启动"><a href="#重载配置和重启docker设置开机启动" class="headerlink" title="重载配置和重启docker设置开机启动"></a>重载配置和重启docker设置开机启动</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7demo docker]# systemctl daemon-reload</span><br><span class="line">[root@centos7demo docker]# systemctl restart docker</span><br><span class="line">[root@centos7demo docker]# systemctl enable docker</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br></pre></td></tr></table></figure>


<h4 id="克隆系统镜像"><a href="#克隆系统镜像" class="headerlink" title="克隆系统镜像"></a>克隆系统镜像</h4><p>以上述过程准备好的虚拟机环境为模板，创建三个虚拟机：master-7.200、node-7.22、node-7.33</p>
<p>分别修改主机名称：master-200、manager-100、dns-11、node-22、node-33</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hostname</span><br></pre></td></tr></table></figure>

<p>修改网络静态IP地址分配为：10.4.7.200、10.4.7.100、10.4.7.11、10.4.7.22、10.4.7.33</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br></pre></td></tr></table></figure>


<h4 id="DNS节点安装bind服务"><a href="#DNS节点安装bind服务" class="headerlink" title="DNS节点安装bind服务"></a>DNS节点安装bind服务</h4><p>bind：<a href="https://www.isc.org/bind/" target="_blank" rel="noopener">https://www.isc.org/bind/</a></p>
<p>现在使用最为广泛的DNS服务器软件是BIND（Berkeley Internet Name Domain），最早有伯克利大学的一名学生编写，现在最新的版本是9，有ISC（Internet Systems Consortium）编写和维护。</p>
<p>BIND支持先今绝大多数的操作系统（Linux，UNIX，Mac，Windows）</p>
<p>BIND服务的名称称之为named</p>
<p>DNS默认使用UDP、TCP协议，使用端口为53（domain），953（mdc，远程控制使用）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure>

<p>修改主配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# vim /etc/named.conf</span><br><span class="line"></span><br><span class="line">listen-on port 53 &#123; 10.4.7.11; &#125;;</span><br><span class="line">allow-query     &#123; any; &#125;;</span><br><span class="line">forwarders      &#123; 10.4.7.254; &#125;;</span><br><span class="line">dnssec-enable no;</span><br><span class="line">dnssec-validation no;</span><br></pre></td></tr></table></figure>

<p>检查配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# named-checkconf</span><br></pre></td></tr></table></figure>

<p>区域配置文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# vim /etc/named.rfc1912.zones </span><br><span class="line"></span><br><span class="line">zone <span class="string">"host.com"</span> <span class="keyword">IN</span> &#123;</span><br><span class="line">       <span class="built_in"> type </span>master;</span><br><span class="line">        file <span class="string">"host.com.zone"</span>;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">"zrf.com"</span> <span class="keyword">IN</span> &#123;</span><br><span class="line">       <span class="built_in"> type </span>master;</span><br><span class="line">        file <span class="string">"zrf.com.zone"</span>;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编辑区域数据文件</p>
<p>主机域</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# vim /var/named/host.com.zone</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ORIGIN host.com.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 600	; 10 minutes</span></span><br><span class="line">@  IN  SOA  dns.host.com.  dnsadmin.host.com. (</span><br><span class="line">       2021051801  ; serial</span><br><span class="line">       10800       ; refresh after 3 hours</span><br><span class="line">       900         ; retry after 15 minutes</span><br><span class="line">       604800      ; expire after 1 week</span><br><span class="line">       86400 	   ; minimum TTL of 1 day</span><br><span class="line">       )</span><br><span class="line">		NS   dns.host.com.</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 60	; 1 minute</span></span><br><span class="line">dns			A 		10.4.7.11</span><br><span class="line">node7-11	A		10.4.7.11</span><br><span class="line">node7-22	A		10.4.7.22</span><br><span class="line">node7-33	A		10.4.7.33</span><br><span class="line">node7-100	A		10.4.7.100</span><br><span class="line">node7-200	A		10.4.7.200</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# vim &#x2F;var&#x2F;named&#x2F;zrf.com.zone</span><br><span class="line"></span><br><span class="line">$ORIGIN zrf.com.</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@  IN  SOA  dns.zrf.com.  dnsadmin.zrf.com. (</span><br><span class="line">       2021051801  ; serial</span><br><span class="line">       10800       ; refresh after 3 hours</span><br><span class="line">       900         ; retry after 15 minutes</span><br><span class="line">       604800      ; expire after 1 week</span><br><span class="line">       86400 	   ; minimum TTL of 1 day</span><br><span class="line">       )</span><br><span class="line">		NS   dns.zrf.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">dns			A 		10.4.7.11</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# named-checkconf</span><br></pre></td></tr></table></figure>

<p>启动DNS服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# systemctl start named</span><br><span class="line">[root@node-11 ~]# systemctl status named</span><br><span class="line"></span><br><span class="line">● named.service - Berkeley Internet Name Domain (DNS)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 二 2021-05-18 19:59:03 CST; 2s ago</span><br><span class="line">  Process: 5702 ExecStart=/usr/sbin/named -u named -c $&#123;NAMEDCONF&#125; $OPTIONS (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 5699 ExecStartPre=/bin/bash -c if [ ! "$DISABLE_ZONE_CHECKING" == "yes" ]; then /usr/sbin/named-checkconf -z "$NAMEDCONF"; else echo "Checking of zone files is disabled"; fi (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 5705 (named)</span><br><span class="line">    Tasks: 5</span><br><span class="line">   Memory: 52.2M</span><br><span class="line">   CGroup: /system.slice/named.service</span><br><span class="line">           └─5705 /usr/sbin/named -u named -c /etc/named.conf</span><br></pre></td></tr></table></figure>

<p>查看进程 监听了 53 端口     </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>node<span class="number">-11</span> ~]# netstat -nltp</span><br><span class="line"></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.4</span><span class="number">.7</span><span class="number">.11</span>:<span class="number">53</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">5705</span>/named          </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">22</span>              <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">885</span>/sshd            </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">953</span>           <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">5705</span>/named          </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">25</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">1110</span>/master         </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">22</span>                   :::*                    LISTEN      <span class="number">885</span>/sshd            </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">953</span>                 :::*                    LISTEN      <span class="number">5705</span>/named          </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">25</span>                  :::*                    LISTEN      <span class="number">1110</span>/master</span><br></pre></td></tr></table></figure>

<p>测试dns</p>
<p>Dig是一个在类Unix命令行模式下查询DNS包括NS记录，A记录，MX记录等相关信息的工具。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>node<span class="number">-11</span> ~]# dig -t A node7<span class="number">-22.</span>host.com @<span class="number">10.4</span><span class="number">.7</span><span class="number">.11</span> +short</span><br><span class="line"></span><br><span class="line"><span class="number">10.4</span><span class="number">.7</span><span class="number">.22</span></span><br></pre></td></tr></table></figure>

<p>修改每个主机的DNS1配置为：10.4.7.11</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="literal">master</span>-<span class="number">200</span> ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DNS1=</span><span class="string">"10.4.7.11"</span></span><br><span class="line"></span><br><span class="line">[root@<span class="keyword">node</span><span class="title">-200</span> ~]<span class="comment"># systemctl restart network</span></span><br></pre></td></tr></table></figure>

<p>配置宿主机（Windows的网络设置）虚拟机网卡（VMware Network Adapter VMnet8）的首选DNS为：10.4.7.11</p>
<p>然后本地 ping 自建域名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\darifo&gt;ping node7-100.host.com</span><br><span class="line"></span><br><span class="line">正在 Ping node7-100.host.com [10.4.7.100] 具有 32 字节的数据:</span><br><span class="line">来自 10.4.7.100 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line">来自 10.4.7.100 的回复: 字节=32 时间=2ms TTL=64</span><br><span class="line">来自 10.4.7.100 的回复: 字节=32 时间=4ms TTL=64</span><br><span class="line">来自 10.4.7.100 的回复: 字节=32 时间=4ms TTL=64</span><br></pre></td></tr></table></figure>

<h4 id="证书签发"><a href="#证书签发" class="headerlink" title="证书签发"></a>证书签发</h4><p>安装在 运维管理主机（10.4.7.100）上</p>
<p>安装 CFSSL R1.2</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span><br><span class="line">wget https:<span class="comment">//pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span><br><span class="line">wget https:<span class="comment">//pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>node<span class="number">-100</span> ~]# ll</span><br><span class="line"></span><br><span class="line">总用量 <span class="number">18812</span></span><br><span class="line">-rw-------. <span class="number">1</span> root root     <span class="number">1218</span> <span class="number">5</span>月  <span class="number">17</span> <span class="number">19</span>:<span class="number">19</span> anaconda-ks.cfg</span><br><span class="line">-rw-r--r--  <span class="number">1</span> root root  <span class="number">6595195</span> <span class="number">4</span>月  <span class="number">17</span> <span class="number">03</span>:<span class="number">17</span> cfssl-certinfo_linux-amd64</span><br><span class="line">-rw-r--r--  <span class="number">1</span> root root  <span class="number">2277873</span> <span class="number">4</span>月  <span class="number">17</span> <span class="number">03</span>:<span class="number">17</span> cfssljson_linux-amd64</span><br><span class="line">-rw-r--r--  <span class="number">1</span> root root <span class="number">10376657</span> <span class="number">4</span>月  <span class="number">17</span> <span class="number">03</span>:<span class="number">17</span> cfssl_linux-amd64</span><br></pre></td></tr></table></figure>

<p>赋予执行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -x cfssl*</span><br></pre></td></tr></table></figure>

<p>重命名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for x in cfssl*; do mv $x $&#123;x%*_linux-amd64&#125;;  done</span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# ll</span><br><span class="line"></span><br><span class="line">总用量 18812</span><br><span class="line">-rw-------. 1 root root     1218 5月  17 19:19 anaconda-ks.cfg</span><br><span class="line">-rw-r--r--  1 root root 10376657 4月  17 03:17 cfssl</span><br><span class="line">-rw-r--r--  1 root root  6595195 4月  17 03:17 cfssl-certinfo</span><br><span class="line">-rw-r--r--  1 root root  2277873 4月  17 03:17 cfssljson</span><br></pre></td></tr></table></figure>

<p>移动文件到目录 (/usr/bin)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 ~]# mv cfssl* /usr/bin</span><br></pre></td></tr></table></figure>

<p>赋执行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 ~]# chmod +x /usr/bin/cfssl*</span><br><span class="line">[root@node-100 ~]# which cfssl</span><br><span class="line"></span><br><span class="line">/usr/bin/cfssl</span><br></pre></td></tr></table></figure>

<p>准备证书目录</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">node</span><span class="title">-100</span> ~]<span class="comment"># cd /opt</span></span><br><span class="line">[root@<span class="keyword">node</span><span class="title">-100</span> opt]<span class="comment"># mkdir certs</span></span><br></pre></td></tr></table></figure>

<p>创建CA证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# vim ca-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	"CN": "Darifo",</span><br><span class="line">	"hosts": [</span><br><span class="line">	</span><br><span class="line">	],</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	"names": [</span><br><span class="line">		&#123;</span><br><span class="line">			"c": "CN",</span><br><span class="line">			"ST": "beijing",</span><br><span class="line">			"L": "beijing",</span><br><span class="line">			"O": "da",</span><br><span class="line">			"OU": "rifo"</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	"ca": &#123;</span><br><span class="line">		"expiry": "175200h"</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line"></span><br><span class="line">2021/05/18 21:18:03 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2021/05/18 21:18:03 [INFO] generate received request</span><br><span class="line">2021/05/18 21:18:03 [INFO] received CSR</span><br><span class="line">2021/05/18 21:18:03 [INFO] generating key: rsa-2048</span><br><span class="line">2021/05/18 21:18:04 [INFO] encoded CSR</span><br><span class="line">2021/05/18 21:18:04 [INFO] signed certificate with serial number 683121607095230134922243035588174960318498579169</span><br><span class="line"></span><br><span class="line">[root@node-100 certs]# ll</span><br><span class="line"></span><br><span class="line">总用量 16</span><br><span class="line">-rw-r--r-- 1 root root  993 5月  18 21:18 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  226 5月  18 21:13 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 5月  18 21:18 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1338 5月  18 21:18 ca.pem</span><br></pre></td></tr></table></figure>

<h4 id="安装Harbor"><a href="#安装Harbor" class="headerlink" title="安装Harbor"></a>安装Harbor</h4><p><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 src]# wget https://github.com/goharbor/harbor/releases/download/v2.1.5/harbor-offline-installer-v2.1.5.tgz</span><br><span class="line"></span><br><span class="line">[root@node-100 src]# tar -zxvf harbor-offline-installer-v2.1.5.tgz -C /opt</span><br><span class="line"></span><br><span class="line">[root@node-100 opt]# mv harbor/ harbor-v2.1.5</span><br><span class="line"></span><br><span class="line">[root@node-100 opt]# ln -s /opt/harbor-v2.1.5/ /opt/harbor</span><br></pre></td></tr></table></figure>

<p>配置 harbor.yml 并创建相关目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 harbor]# vim harbor.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hostname: harbor.zrf.com</span><br><span class="line">http:</span><br><span class="line">  port: 180</span><br><span class="line">harbor_admin_password: 12345678</span><br><span class="line">data_volume: /data/harbor</span><br><span class="line">log:</span><br><span class="line">    location: /data/harbor/logs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-100 harbor]# mkdir -p /data/harbor/logs</span><br></pre></td></tr></table></figure>

<p>安装docker-compose</p>
<p><a href="https://github.com/docker/compose/releases/" target="_blank" rel="noopener">https://github.com/docker/compose/releases/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 src]# mv docker-compose-Linux-x86_64 docker-compose</span><br><span class="line"></span><br><span class="line">[root@node-100 src]# mv docker-compose /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">[root@node-100 src]# chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">[root@node-100 src]# sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br><span class="line"></span><br><span class="line">[root@node-100 src]# docker-compose version</span><br><span class="line"></span><br><span class="line">docker-compose version 1.29.2, build 5becea4c</span><br><span class="line">docker-py version: 5.0.0</span><br><span class="line">CPython version: 3.7.10</span><br><span class="line">OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019</span><br></pre></td></tr></table></figure>

<p>执行安装脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 harbor]# ./install.sh </span><br><span class="line"></span><br><span class="line">[Step 0]: checking if docker is installed ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 20.10.6</span><br><span class="line"></span><br><span class="line">[Step 1]: checking docker-compose is installed ...</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.29.2</span><br><span class="line"></span><br><span class="line">[Step 2]: loading Harbor images ...</span><br><span class="line"></span><br><span class="line">[Step 5]: starting Harbor ...</span><br><span class="line">Creating network "harbor-v215_harbor" with the default driver</span><br><span class="line">Creating harbor-log ... done</span><br><span class="line">Creating registry      ... done</span><br><span class="line">Creating harbor-portal ... done</span><br><span class="line">Creating redis         ... done</span><br><span class="line">Creating harbor-db     ... done</span><br><span class="line">Creating registryctl   ... done</span><br><span class="line">Creating harbor-core   ... done</span><br><span class="line">Creating harbor-jobservice ... done</span><br><span class="line">Creating nginx             ... done</span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br></pre></td></tr></table></figure>

<p>启动 Harbor</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 harbor]# docker-compose up -d</span><br><span class="line"></span><br><span class="line">harbor-log is up-to-date</span><br><span class="line">Starting harbor-db     ... done</span><br><span class="line">Starting registry      ... done</span><br><span class="line">Starting redis         ... done</span><br><span class="line">Starting registryctl   ... done</span><br><span class="line">Starting harbor-portal ... done</span><br><span class="line">Starting harbor-core   ... done</span><br><span class="line">Starting nginx             ... done</span><br><span class="line">Starting harbor-jobservice ... done</span><br></pre></td></tr></table></figure>

<p>安装 Nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 harbor]# cd /etc/yum.repos.d/</span><br><span class="line">[root@node-100 yum.repos.d]#  vim nginx.repo </span><br><span class="line"></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line"></span><br><span class="line">[root@node-100 yum.repos.d]# yum install nginx -y</span><br></pre></td></tr></table></figure>

<p>配置Nginx代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 ~]# vim /etc/nginx/conf.d/harbor.zrf.com.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen	80;</span><br><span class="line">	server_name	harbor.zrf.com;</span><br><span class="line">	</span><br><span class="line">	client_max_body_size	1000m;</span><br><span class="line">	</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass	http://127.0.0.1:180;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# systemctl enable nginx</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br></pre></td></tr></table></figure>


<p>配置DNS服务器解析 (10.4.7.11上)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 ~]# vim /var/named/zrf.com.zone </span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ORIGIN zrf.com.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 600        ; 10 minutes</span></span><br><span class="line">@  IN  SOA  dns.zrf.com.  dnsadmin.zrf.com. (</span><br><span class="line">       2021051802  ; serial</span><br><span class="line">       10800       ; refresh after 3 hours</span><br><span class="line">       900         ; retry after 15 minutes</span><br><span class="line">       604800      ; expire after 1 week</span><br><span class="line">       86400       ; minimum TTL of 1 day</span><br><span class="line">       )</span><br><span class="line">                NS   dns.zrf.com.</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 60 ; 1 minute</span></span><br><span class="line">dns                     A               10.4.7.11</span><br><span class="line">harbor                  A               10.4.7.100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次修改DNS解析记录记得修改 serial 值</span></span><br><span class="line"></span><br><span class="line">[root@node-11 ~]# systemctl restart named</span><br></pre></td></tr></table></figure>

<p>浏览器访问：</p>
<p><a href="http://harbor.zrf.com/" target="_blank" rel="noopener">http://harbor.zrf.com/</a></p>
<p>管理节点（10.4.7.100）上配置docker的 registry-mirrors （镜像加速地址）和 insecure-registries（私有仓库地址）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 ~]# vim /etc/docker/daemon.json </span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": [</span><br><span class="line">        "https://6adf82tk.mirror.aliyuncs.com",</span><br><span class="line">        "https://docker.mirrors.ustc.edu.cn",</span><br><span class="line">        "https://registry.docker-cn.com"</span><br><span class="line">  ],</span><br><span class="line">  "insecure-registries": [</span><br><span class="line">        "harbor.zrf.com"</span><br><span class="line">  ],</span><br><span class="line">  "bip": "172.7.100.1/24",</span><br><span class="line">  "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">  "log-driver": "json-file",</span><br><span class="line">  "log-opts": &#123;</span><br><span class="line">    "max-size": "100m"</span><br><span class="line">  &#125;,</span><br><span class="line">  "storage-driver": "overlay2"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# systemctl daemon-reload</span><br><span class="line">[root@node-100 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# cd /opt/harbor</span><br><span class="line">[root@node-100 harbor]# docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>查看Docker的桥接网卡</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 harbor]# docker<span class="built_in"> network </span>inspect bridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"e17b9f7b289ed8e90f5e803c460dfd54e09c82d62a2a778a4d237f249eba69ab"</span>,</span><br><span class="line">        <span class="string">"Created"</span>: <span class="string">"2021-05-19T00:27:54.304910387+08:00"</span>,</span><br><span class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"IPAM"</span>: &#123;</span><br><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"Options"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="string">"Config"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.7.100.0/24"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.7.100.1"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Attachable"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Ingress"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"ConfigFrom"</span>: &#123;</span><br><span class="line">            <span class="string">"Network"</span>: <span class="string">""</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"ConfigOnly"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Containers"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"Options"</span>: &#123;</span><br><span class="line">            <span class="string">"com.docker.network.bridge.default_bridge"</span>: <span class="string">"true"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.enable_icc"</span>: <span class="string">"true"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.enable_ip_masquerade"</span>: <span class="string">"true"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.host_binding_ipv4"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.name"</span>: <span class="string">"docker0"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.driver.mtu"</span>: <span class="string">"1500"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Labels"</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>测试镜像推送</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 ~]# docker pull nginx:1.20</span><br><span class="line"></span><br><span class="line">1.20: Pulling from library/nginx</span><br><span class="line">69692152171a: Pull complete </span><br><span class="line">965615a5cec8: Pull complete </span><br><span class="line">b141b026b9ce: Pull complete </span><br><span class="line">8d70dc384fb3: Pull complete </span><br><span class="line">525e372d6dee: Pull complete </span><br><span class="line">6e60219fdb98: Pull complete </span><br><span class="line">Digest: sha256:ea4560b87ff03479670d15df426f7d02e30cb6340dcd3004cdfc048d6a1d54b4</span><br><span class="line">Status: Downloaded newer image for nginx:1.20</span><br><span class="line">docker.io/library/nginx:1.20</span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# docker images | grep nginx</span><br><span class="line">nginx                           1.20      7ab27dbbfbdf   6 days ago    133MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# docker tag 7ab27dbbfbdf harbor.zrf.com/public/nginx:v1.20</span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# docker login harbor.zrf.com</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-100 ~]# docker push harbor.zrf.com/public/nginx:v1.20</span><br><span class="line">The push refers to repository [harbor.zrf.com/public/nginx]</span><br><span class="line">272bc57d3405: Pushed </span><br><span class="line">f7141923aaa3: Pushed </span><br><span class="line">9b63e6289fbe: Pushed </span><br><span class="line">a2f4f809e04e: Pushed </span><br><span class="line">1839f9962bd8: Pushed </span><br><span class="line">02c055ef67f5: Pushed </span><br><span class="line">v1.20: digest: sha256:598057a5c482d2fb42092fd6f4ba35ea4cc86c41f5db8bb68d1ab92c4c40db98 size: 1570</span><br></pre></td></tr></table></figure>

<h4 id="安装-K8s"><a href="#安装-K8s" class="headerlink" title="安装 K8s"></a>安装 K8s</h4><p>在管理节点（10.4.7.100）上</p>
<p>创建根证书配置文件</p>
<p>vim  /opt/certs/ca-config.json</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@<span class="keyword">node</span><span class="title">-100</span> ~]<span class="comment"># cd /opt/certs/</span></span><br><span class="line"></span><br><span class="line">[root@<span class="keyword">node</span><span class="title">-100</span> certs]<span class="comment"># vim ca-config.json</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"175200h"</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>:&#123;</span><br><span class="line">      <span class="string">"server"</span>: &#123;</span><br><span class="line">       <span class="string">"expiry"</span>: <span class="string">"175200h"</span>,</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"client"</span>: &#123;</span><br><span class="line">       <span class="string">"expiry"</span>: <span class="string">"175200h"</span>,</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"peer"</span>: &#123;</span><br><span class="line">       <span class="string">"expiry"</span>: <span class="string">"175200h"</span>,</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建根证书请求文件 etcd-peer-csr.json</p>
<p>vim /opt/certs/etcd-peer-csr.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"k8s-etcd"</span>,</span><br><span class="line">  <span class="attr">"hosts"</span>: [</span><br><span class="line">    <span class="string">"10.4.7.200"</span>,</span><br><span class="line">    <span class="string">"10.4.7.11"</span>,</span><br><span class="line">    <span class="string">"10.4.7.22"</span>,</span><br><span class="line">    <span class="string">"10.4.7.33"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"zrf"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"rf"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 生成etcd用的证书文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@node-100 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json | cfssljson -bare etcd-peer</span><br><span class="line"></span><br><span class="line">2021/05/19 02:56:59 [INFO] generate received request</span><br><span class="line">2021/05/19 02:56:59 [INFO] received CSR</span><br><span class="line">2021/05/19 02:56:59 [INFO] generating key: rsa-2048</span><br><span class="line">2021/05/19 02:56:59 [INFO] encoded CSR</span><br><span class="line">2021/05/19 02:56:59 [INFO] signed certificate with serial number 459984002147105853352453930204597808407893791844</span><br><span class="line">2021/05/19 02:56:59 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br><span class="line">[root@node-100 certs]# ll</span><br><span class="line">总用量 36</span><br><span class="line">-rw-r--r-- 1 root root  599 5月  19 00:55 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  993 5月  18 21:18 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  226 5月  18 21:13 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 5月  18 21:18 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1338 5月  18 21:18 ca.pem</span><br><span class="line">-rw-r--r-- 1 root root 1062 5月  19 02:56 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root  288 5月  19 02:03 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1675 5月  19 02:56 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1424 5月  19 02:56 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h5 id="master节点（10-4-7-200）安装etcd"><a href="#master节点（10-4-7-200）安装etcd" class="headerlink" title="master节点（10.4.7.200）安装etcd"></a>master节点（10.4.7.200）安装etcd</h5><p>主节点（10.4.7.200）</p>
<p>创建用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 ~]# useradd -s /sbin/nologin -M etcd</span><br><span class="line">[root@master-200 ~]# id etcd</span><br><span class="line">uid=1000(etcd) gid=1000(etcd) 组=1000(etcd)</span><br></pre></td></tr></table></figure>

<p>下载软件</p>
<p><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.4.16/etcd-v3.4.16-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">[root@master-200 ~]# tar xfv etcd-v3.4.16-linux-amd64.tar.gz -C /opt</span><br><span class="line"></span><br><span class="line">[root@master-200 ~]# cd /opt/</span><br><span class="line"></span><br><span class="line">[root@master-200 opt]# mv etcd-v3.4.16-linux-amd64/ etcd-v3.4.16</span><br><span class="line">[root@master-200 opt]# ln -s /opt/etcd-v3.4.16/ /opt/etcd</span><br><span class="line">[root@master-200 opt]# cd etcd</span><br></pre></td></tr></table></figure>

<p>创建数据目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br></pre></td></tr></table></figure>

<p>授权用户目录权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# chown -R etcd.etcd /opt/etcd-v3.4.16/</span><br><span class="line">[root@master-200 etcd]# chown -R etcd.etcd /data/etcd/</span><br><span class="line">[root@master-200 etcd]# chown -R etcd.etcd /data/logs/etcd-server/</span><br></pre></td></tr></table></figure>

<p>拷贝证书从管理节点（10.4.7.100）到主节点（10.4.7.200）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# cd /opt/certs</span><br><span class="line">[root@master-200 certs]# scp node7-100.host.com:/opt/certs/etcd-peer.pem .</span><br><span class="line">[root@master-200 certs]# scp node7-100.host.com:/opt/certs/ca.pem .</span><br><span class="line">[root@master-200 certs]# scp node7-100.host.com:/opt/certs/etcd-peer-key.pem .</span><br></pre></td></tr></table></figure>

<p>配置etcd启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# vim etcd-server-startup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./etcd --name etcd-7-200 \</span><br><span class="line">        --data-dir /data/logs/etcd-server \</span><br><span class="line">        --listen-peer-urls https://10.4.7.200:2380 \</span><br><span class="line">        --listen-client-urls https://10.4.7.200:2379,http://127.0.0.1:2379 \</span><br><span class="line">        --quota-backend-bytes 8000000000 \</span><br><span class="line">        --advertise-client-urls https://10.4.7.200:2379,http://127.0.0.1:2379 \</span><br><span class="line">        --initial-advertise-peer-urls https://10.4.7.200:2380 \</span><br><span class="line">        --initial-cluster etcd-7-200=https://10.4.7.200:2380,etcd-7-22=https://10.4.7.22:2380,etcd-7-33=https://10.4.7.33:2380 \</span><br><span class="line">        --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">        --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">        --client-cert-auth \</span><br><span class="line">        --trusted-ca-file ./certs/ca.pem  \</span><br><span class="line">        --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">        --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">        --peer-client-cert-auth \</span><br><span class="line">        --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">        --log-output stdout</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# chmod +x etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p>安装 supervisor 软件 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# yum install epel-release</span><br><span class="line">[root@master-200 etcd]# yum install -y supervisor</span><br><span class="line">[root@master-200 etcd]# systemctl enable supervisord</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/supervisord.service to /usr/lib/systemd/system/supervisord.service.</span><br><span class="line"></span><br><span class="line">[root@master-200 etcd]# systemctl start supervisord</span><br><span class="line">[root@master-200 etcd]# systemctl status supervisord</span><br><span class="line"></span><br><span class="line">● supervisord.service - Process Monitoring and Control Daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/supervisord.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 三 2021-05-19 04:31:51 CST; 28s ago</span><br><span class="line">  Process: 6265 ExecStart=/usr/bin/supervisord -c /etc/supervisord.conf (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 6268 (supervisord)</span><br><span class="line">    Tasks: 1</span><br><span class="line">   Memory: 10.9M</span><br><span class="line">   CGroup: /system.slice/supervisord.service</span><br><span class="line">           └─6268 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">5月 19 04:31:51 master-200 systemd[1]: Starting Process Monitoring and Control Daemon...</span><br><span class="line">5月 19 04:31:51 master-200 systemd[1]: Started Process Monitoring and Control Daemon.</span><br></pre></td></tr></table></figure>


<p>配置 supervisor 的 etcd-server.ini</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# vim /etc/supervisord.d/etcd-server.ini</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">内容如下</span></span><br><span class="line">[program:etcd-server-7-200]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh</span><br><span class="line">numprocs=1</span><br><span class="line">directory=/opt/etcd</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=30</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=QUIT</span><br><span class="line">stopwaitsecs=10</span><br><span class="line">user=etcd</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log</span><br><span class="line">stdout_logfile_maxbytes=64MB</span><br><span class="line">stdout_logfile_backups=4</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_events_enabled=false</span><br></pre></td></tr></table></figure>

<p>更新和启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 etcd]# supervisorctl update</span><br><span class="line">etcd-server-7-200: added process group</span><br><span class="line"></span><br><span class="line">[root@master-200 etcd]# supervisorctl reload</span><br><span class="line">Restarted supervisord</span><br><span class="line"></span><br><span class="line">[root@master-200 etcd]# tail -fn 200 /data/logs/etcd-server/etcd.stdout.log</span><br><span class="line"></span><br><span class="line">[root@master-200 etcd]# supervisorctl status</span><br><span class="line">etcd-server-7-200                RUNNING   pid 6517, uptime 0:00:34</span><br></pre></td></tr></table></figure>

<h5 id="计算节点1（10-4-7-22）安装etcd"><a href="#计算节点1（10-4-7-22）安装etcd" class="headerlink" title="计算节点1（10.4.7.22）安装etcd"></a>计算节点1（10.4.7.22）安装etcd</h5><p>基础批处理命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建用户</span></span><br><span class="line">useradd -s /sbin/nologin -M etcd</span><br><span class="line">id etcd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载ETCD</span></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.4.16/etcd-v3.4.16-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压重命名</span></span><br><span class="line">tar xfv etcd-v3.4.16-linux-amd64.tar.gz -C /opt</span><br><span class="line">cd /opt/</span><br><span class="line">mv etcd-v3.4.16-linux-amd64/ etcd-v3.4.16</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 建立软连接</span></span><br><span class="line">ln -s /opt/etcd-v3.4.16/ /opt/etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建etcd数据目录</span></span><br><span class="line">mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br><span class="line">chown -R etcd.etcd /opt/etcd-v3.4.16/</span><br><span class="line">chown -R etcd.etcd /data/etcd/</span><br><span class="line">chown -R etcd.etcd /data/logs/etcd-server/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从管理节点拷贝证书到本机</span></span><br><span class="line">cd /opt/etcd/certs</span><br><span class="line"></span><br><span class="line">scp node7-100.host.com:/opt/certs/etcd-peer.pem .</span><br><span class="line">scp node7-100.host.com:/opt/certs/ca.pem .</span><br><span class="line">scp node7-100.host.com:/opt/certs/etcd-peer-key.pem .</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 supervisor 软件</span></span><br><span class="line">yum install epel-release</span><br><span class="line">yum install -y supervisor</span><br><span class="line">systemctl enable supervisord</span><br><span class="line">systemctl start supervisord</span><br><span class="line">systemctl status supervisord</span><br></pre></td></tr></table></figure>

<p>编辑启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/etcd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑启动脚本</span></span><br><span class="line">vim etcd-server-startup.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./etcd --name etcd-7-22 \</span><br><span class="line">        --data-dir /data/logs/etcd-server \</span><br><span class="line">        --listen-peer-urls https://10.4.7.22:2380 \</span><br><span class="line">        --listen-client-urls https://10.4.7.22:2379,http://127.0.0.1:2379 \</span><br><span class="line">        --quota-backend-bytes 8000000000 \</span><br><span class="line">        --advertise-client-urls https://10.4.7.22:2379,http://127.0.0.1:2379 \</span><br><span class="line">        --initial-advertise-peer-urls https://10.4.7.22:2380 \</span><br><span class="line">        --initial-cluster etcd-7-200=https://10.4.7.200:2380,etcd-7-22=https://10.4.7.22:2380,etcd-7-33=https://10.4.7.33:2380 \</span><br><span class="line">        --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">        --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">        --client-cert-auth \</span><br><span class="line">        --trusted-ca-file ./certs/ca.pem  \</span><br><span class="line">        --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">        --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">        --peer-client-cert-auth \</span><br><span class="line">        --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">        --log-output stdout</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod +x etcd-server-startup.sh</span><br><span class="line">chown -R etcd.etcd /opt/etcd-v3.4.16/ /data/etcd/ /data/logs/etcd-server/</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置etcd-server的进程守护</span></span><br><span class="line">vim /etc/supervisord.d/etcd-server.ini</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">内容如下</span></span><br><span class="line">[program:etcd-server-7-22]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh</span><br><span class="line">numprocs=1</span><br><span class="line">directory=/opt/etcd</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=30</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=QUIT</span><br><span class="line">stopwaitsecs=10</span><br><span class="line">user=etcd</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log</span><br><span class="line">stdout_logfile_maxbytes=64MB</span><br><span class="line">stdout_logfile_backups=4</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_events_enabled=false</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 更新重载查看 supervisor</span></span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> tail -fn 200 /data/logs/etcd-server/etcd.stdout.log</span></span><br><span class="line">supervisorctl status</span><br></pre></td></tr></table></figure>


<h5 id="计算节点2（10-4-7-33）安装etcd"><a href="#计算节点2（10-4-7-33）安装etcd" class="headerlink" title="计算节点2（10.4.7.33）安装etcd"></a>计算节点2（10.4.7.33）安装etcd</h5><p>基础操作同上</p>
<p>区别安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim etcd-server-startup.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./etcd --name etcd-7-33 \</span><br><span class="line">        --data-dir /data/logs/etcd-server \</span><br><span class="line">        --listen-peer-urls https://10.4.7.33:2380 \</span><br><span class="line">        --listen-client-urls https://10.4.7.33:2379,http://127.0.0.1:2379 \</span><br><span class="line">        --quota-backend-bytes 8000000000 \</span><br><span class="line">        --advertise-client-urls https://10.4.7.33:2379,http://127.0.0.1:2379 \</span><br><span class="line">        --initial-advertise-peer-urls https://10.4.7.33:2380 \</span><br><span class="line">        --initial-cluster etcd-7-200=https://10.4.7.200:2380,etcd-7-22=https://10.4.7.22:2380,etcd-7-33=https://10.4.7.33:2380 \</span><br><span class="line">        --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">        --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">        --client-cert-auth \</span><br><span class="line">        --trusted-ca-file ./certs/ca.pem  \</span><br><span class="line">        --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">        --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">        --peer-client-cert-auth \</span><br><span class="line">        --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">        --log-output stdout</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置etcd-server的进程守护</span></span><br><span class="line">vim /etc/supervisord.d/etcd-server.ini</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">内容如下</span></span><br><span class="line">[program:etcd-server-7-33]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh</span><br><span class="line">numprocs=1</span><br><span class="line">directory=/opt/etcd</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=30</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=QUIT</span><br><span class="line">stopwaitsecs=10</span><br><span class="line">user=etcd</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log</span><br><span class="line">stdout_logfile_maxbytes=64MB</span><br><span class="line">stdout_logfile_backups=4</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_events_enabled=false</span><br></pre></td></tr></table></figure>

<h5 id="下载安装-kubernetes"><a href="#下载安装-kubernetes" class="headerlink" title="下载安装 kubernetes"></a>下载安装 kubernetes</h5><p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG</a></p>
<p><a href="https://dl.k8s.io/v1.21.1/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.21.1/kubernetes-server-linux-amd64.tar.gz</a></p>
<p>本机下载后上传到 7-100，然后远程拷贝到计算节点</p>
<h6 id="计算节点1（10-4-7-22）安装k8s"><a href="#计算节点1（10-4-7-22）安装k8s" class="headerlink" title="计算节点1（10.4.7.22）安装k8s"></a>计算节点1（10.4.7.22）安装k8s</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master-22 opt]# scp node7-100.host.com:/opt/src/kubernetes-server-linux-amd64.tar.gz .</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master-22 opt]# tar xfv kubernetes-server-linux-amd64.tar.gz -C /opt</span><br><span class="line"></span><br><span class="line">[root@master-22 opt]# mv kubernetes kubernetes-v1.21.1</span><br><span class="line"></span><br><span class="line">[root@master-22 opt]# ln -s kubernetes-v1.21.1/ kubernetes</span><br><span class="line"></span><br><span class="line">[root@master-22 opt]# cd kubernetes</span><br><span class="line"></span><br><span class="line">[root@master-22 kubernetes]# rm -rf kubernetes-src.tar.gz</span><br><span class="line"></span><br><span class="line">[root@master-22 kubernetes]# cd server/</span><br><span class="line">[root@master-22 server]# cd bin/</span><br><span class="line">[root@master-22 bin]# rm -f *.tar</span><br><span class="line">[root@master-22 bin]# rm -f *_tag</span><br><span class="line">[root@master-22 bin]# ll</span><br><span class="line">总用量 680144</span><br><span class="line">-rwxr-xr-x 1 root root  50577408 5月  12 22:30 apiextensions-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root  46501888 5月  12 22:30 kubeadm</span><br><span class="line">-rwxr-xr-x 1 root root  48521216 5月  12 22:30 kube-aggregator</span><br><span class="line">-rwxr-xr-x 1 root root 122085376 5月  12 22:30 kube-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root 116297728 5月  12 22:30 kube-controller-manager</span><br><span class="line">-rwxr-xr-x 1 root root  47583232 5月  12 22:30 kubectl</span><br><span class="line">-rwxr-xr-x 1 root root  54980712 5月  12 22:30 kubectl-convert</span><br><span class="line">-rwxr-xr-x 1 root root 118083408 5月  12 22:30 kubelet</span><br><span class="line">-rwxr-xr-x 1 root root  43130880 5月  12 22:30 kube-proxy</span><br><span class="line">-rwxr-xr-x 1 root root  47108096 5月  12 22:30 kube-scheduler</span><br><span class="line">-rwxr-xr-x 1 root root   1593344 5月  12 22:30 mounter</span><br></pre></td></tr></table></figure>

<p>终于启动了etcd集群</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node-33 etcd]# kubectl <span class="builtin-name">get</span> cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>


<h6 id="计算节点1（10-4-7-33）安装k8s"><a href="#计算节点1（10-4-7-33）安装k8s" class="headerlink" title="计算节点1（10.4.7.33）安装k8s"></a>计算节点1（10.4.7.33）安装k8s</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-33 opt]# scp node7-100.host.com:/opt/src/kubernetes-server-linux-amd64.tar.gz .</span><br></pre></td></tr></table></figure>

<p>其余操作同上。</p>
<h5 id="签发k8s证书"><a href="#签发k8s证书" class="headerlink" title="签发k8s证书"></a>签发k8s证书</h5><p>在管理运维机器节点（10.4.7.100）上</p>
<p>client证书配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# vim client-csr.json</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"CN"</span>: <span class="string">"k8s-node"</span>,</span><br><span class="line">	<span class="attr">"hosts"</span>: [</span><br><span class="line">	</span><br><span class="line">	],</span><br><span class="line">	<span class="attr">"key"</span>: &#123;</span><br><span class="line">		<span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">		<span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"names"</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">"c"</span>: <span class="string">"CN"</span>,</span><br><span class="line">			<span class="attr">"ST"</span>: <span class="string">"beijing"</span>,</span><br><span class="line">			<span class="attr">"L"</span>: <span class="string">"beijing"</span>,</span><br><span class="line">			<span class="attr">"O"</span>: <span class="string">"da"</span>,</span><br><span class="line">			<span class="attr">"OU"</span>: <span class="string">"rifo"</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>签发 Client 证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssljson -bare client</span><br><span class="line"></span><br><span class="line">2021/05/19 10:57:50 [INFO] generate received request</span><br><span class="line">2021/05/19 10:57:50 [INFO] received CSR</span><br><span class="line">2021/05/19 10:57:50 [INFO] generating key: rsa-2048</span><br><span class="line">2021/05/19 10:57:51 [INFO] encoded CSR</span><br><span class="line">2021/05/19 10:57:51 [INFO] signed certificate with serial number 350439271737060455865399561233766765490411981295</span><br><span class="line">2021/05/19 10:57:51 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></figure>

<p>api-server证书配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# vim apiserver-csr.json</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"k8s-apiserver"</span>,</span><br><span class="line">    <span class="attr">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"192.168.0.1"</span>,</span><br><span class="line">        <span class="string">"10.0.0.1"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster.local"</span>,</span><br><span class="line">        <span class="string">"10.4.7.110"</span>,</span><br><span class="line">        <span class="string">"10.4.7.200"</span>,</span><br><span class="line">        <span class="string">"10.4.7.22"</span>,</span><br><span class="line">        <span class="string">"10.4.7.33"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"beijing"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"beijing"</span>,</span><br><span class="line">            <span class="attr">"O"</span>: <span class="string">"da"</span>,</span><br><span class="line">            <span class="attr">"OU"</span>: <span class="string">"rifo"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>api-server证书生成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssljson -bare apiserver</span><br><span class="line"></span><br><span class="line">2021/05/19 13:01:12 [INFO] generate received request</span><br><span class="line">2021/05/19 13:01:12 [INFO] received CSR</span><br><span class="line">2021/05/19 13:01:12 [INFO] generating key: rsa-2048</span><br><span class="line">2021/05/19 13:01:12 [INFO] encoded CSR</span><br><span class="line">2021/05/19 13:01:12 [INFO] signed certificate with serial number 282787114856344111889075867610902440531740473558</span><br><span class="line">2021/05/19 13:01:12 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></figure>

<h5 id="将证书拷贝到各个计算节点"><a href="#将证书拷贝到各个计算节点" class="headerlink" title="将证书拷贝到各个计算节点"></a>将证书拷贝到各个计算节点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@node-22 bin]# mkdir cert</span><br><span class="line"></span><br><span class="line">[root@node-22 cert]# scp node7-100.host.com:/opt/certs/ca.pem .</span><br><span class="line">[root@node-22 cert]# scp node7-100.host.com:/opt/certs/ca-key.pem .</span><br><span class="line">[root@node-22 cert]# scp node7-100.host.com:/opt/certs/client.pem .</span><br><span class="line">[root@node-22 cert]# scp node7-100.host.com:/opt/certs/client-key.pem .</span><br><span class="line">[root@node-22 cert]# scp node7-100.host.com:/opt/certs/apiserver.pem .</span><br><span class="line">[root@node-22 cert]# scp node7-100.host.com:/opt/certs/apiserver-key.pem .</span><br><span class="line"></span><br><span class="line">[root@node-22 cert]# ll</span><br><span class="line">总用量 24</span><br><span class="line">-rw------- 1 root root 1675 5月  19 13:16 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1598 5月  19 13:15 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1675 5月  19 13:15 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1338 5月  19 13:15 ca.pem</span><br><span class="line">-rw------- 1 root root 1675 5月  19 13:15 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1363 5月  19 13:15 client.pem</span><br></pre></td></tr></table></figure>



<h5 id="创建-apiserver启动配置文件"><a href="#创建-apiserver启动配置文件" class="headerlink" title="创建 apiserver启动配置文件"></a>创建 apiserver启动配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 bin]# mkdir conf</span><br><span class="line"></span><br><span class="line">/opt/kubernetes/server/bin/conf</span><br><span class="line"></span><br><span class="line">[root@node-22 conf]# vim audit.yaml</span><br></pre></td></tr></table></figure>



<p>audit.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1beta1</span> <span class="comment"># This is required.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="comment"># Don't generate audit events for all requests in RequestReceived stage.</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"RequestReceived"</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Log pod changes at RequestResponse level</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestResponse</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">      <span class="comment"># Resource "pods" doesn't match requests to any subresource of pods,</span></span><br><span class="line">      <span class="comment"># which is consistent with the RBAC policy.</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["pods"]</span></span><br><span class="line">  <span class="comment"># Log "pods/log", "pods/status" at Metadata level</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["pods/log",</span> <span class="string">"pods/status"</span><span class="string">]</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Don't log requests to a configmap called "controller-leader"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">      <span class="attr">resourceNames:</span> <span class="string">["controller-leader"]</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Don't log watch requests by the "system:kube-proxy" on endpoints or services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">users:</span> <span class="string">["system:kube-proxy"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["watch"]</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span> <span class="comment"># core API group</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["endpoints",</span> <span class="string">"services"</span><span class="string">]</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Don't log authenticated requests to certain non-resource URL paths.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">userGroups:</span> <span class="string">["system:authenticated"]</span></span><br><span class="line">    <span class="attr">nonResourceURLs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"/api*"</span> <span class="comment"># Wildcard matching.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"/version"</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Log the request body of configmap changes in kube-system.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span> <span class="comment"># core API group</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">    <span class="comment"># This rule only applies to resources in the "kube-system" namespace.</span></span><br><span class="line">    <span class="comment"># The empty string "" can be used to select non-namespaced resources.</span></span><br><span class="line">    <span class="attr">namespaces:</span> <span class="string">["kube-system"]</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Log configmap and secret changes in all other namespaces at the Metadata level.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span> <span class="comment"># core API group</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">["secrets",</span> <span class="string">"configmaps"</span><span class="string">]</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Log all other resources in core and extensions at the Request level.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span> <span class="comment"># core API group</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">"extensions"</span> <span class="comment"># Version of group should NOT be included.</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># A catch-all rule to log all other requests at the Metadata level.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="comment"># Long-running requests like watches that fall under this rule will not</span></span><br><span class="line">    <span class="comment"># generate an audit event in RequestReceived.</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"RequestReceived"</span></span><br></pre></td></tr></table></figure>

<p>副本</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: audit.k8s.io/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: Policy</span><br><span class="line"><span class="attribute">omitStages</span>:</span><br><span class="line">  - <span class="string">"RequestReceived"</span></span><br><span class="line"><span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">level</span>: RequestResponse</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span></span><br><span class="line">      <span class="attribute">resources</span>: [<span class="string">"pods"</span>]</span><br><span class="line">  - <span class="attribute">level</span>: Metadata</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span></span><br><span class="line">      <span class="attribute">resources</span>: [<span class="string">"pods/log"</span>, <span class="string">"pods/status"</span>]</span><br><span class="line"></span><br><span class="line">  - <span class="attribute">level</span>: None</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span></span><br><span class="line">      <span class="attribute">resources</span>: [<span class="string">"configmaps"</span>]</span><br><span class="line">      <span class="attribute">resourceNames</span>: [<span class="string">"controller-leader"</span>]</span><br><span class="line"> </span><br><span class="line">  - <span class="attribute">level</span>: None</span><br><span class="line">    <span class="attribute">users</span>: [<span class="string">"system:kube-proxy"</span>]</span><br><span class="line">    <span class="attribute">verbs</span>: [<span class="string">"watch"</span>]</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span> </span><br><span class="line">      <span class="attribute">resources</span>: [<span class="string">"endpoints"</span>, <span class="string">"services"</span>]</span><br><span class="line">	  </span><br><span class="line">  - <span class="attribute">level</span>: None</span><br><span class="line">    <span class="attribute">userGroups</span>: [<span class="string">"system:authenticated"</span>]</span><br><span class="line">    <span class="attribute">nonResourceURLs</span>:</span><br><span class="line">    - <span class="string">"/api*"</span> </span><br><span class="line">    - <span class="string">"/version"</span></span><br><span class="line"> </span><br><span class="line">  - <span class="attribute">level</span>: Request</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span> </span><br><span class="line">      <span class="attribute">resources</span>: [<span class="string">"configmaps"</span>]</span><br><span class="line">    <span class="attribute">namespaces</span>: [<span class="string">"kube-system"</span>]</span><br><span class="line"> </span><br><span class="line">  - <span class="attribute">level</span>: Metadata</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span> </span><br><span class="line">      <span class="attribute">resources</span>: [<span class="string">"secrets"</span>, <span class="string">"configmaps"</span>]</span><br><span class="line"></span><br><span class="line">  - <span class="attribute">level</span>: Request</span><br><span class="line">    <span class="attribute">resources</span>:</span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">""</span> </span><br><span class="line">    - <span class="attribute">group</span>: <span class="string">"extensions"</span> </span><br><span class="line"></span><br><span class="line">  - <span class="attribute">level</span>: Metadata</span><br><span class="line">    <span class="attribute">omitStages</span>:</span><br><span class="line">      - <span class="string">"RequestReceived"</span></span><br></pre></td></tr></table></figure>

<p>kube-apiserver 启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin</span><br><span class="line"></span><br><span class="line">[root@node-22 bin]# vim kube-apiserver.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">./kube-apiserver \</span><br><span class="line">        --insecure-port 8080 \</span><br><span class="line">        --insecure-bind-address 0.0.0.0 \</span><br><span class="line">        --apiserver-count 2 \</span><br><span class="line">        --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">        --audit-policy-file ./conf/audit.yaml \</span><br><span class="line">        --authorization-mode Node,RBAC \</span><br><span class="line">        --client-ca-file ./cert/ca.pem \</span><br><span class="line">        --requestheader-client-ca-file ./cert/ca.pem \</span><br><span class="line">        --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">      --etcd-cafile ./cert/ca.pem \</span><br><span class="line">      --etcd-certfile ./cert/client.pem \</span><br><span class="line">      --etcd-keyfile ./cert/client-key.pem \</span><br><span class="line">      --etcd-servers https://10.4.7.200:2379,https://10.4.7.22:2379,https://10.4.7.33:2379 \</span><br><span class="line">      --service-account-signing-key-file ./cert/ca-key.pem \</span><br><span class="line">      --service-account-issuer api \</span><br><span class="line">      --service-account-key-file ./cert/ca-key.pem \</span><br><span class="line">      --service-node-port-range 3000-29999 \</span><br><span class="line">      --target-ram-mb=1024 \</span><br><span class="line">      --kubelet-client-certificate ./cert/client.pem \</span><br><span class="line">      --kubelet-client-key ./cert/client-key.pem \</span><br><span class="line">      --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">      --tls-cert-file ./cert/apiserver.pem \</span><br><span class="line">      --tls-private-key-file ./cert/apiserver-key.pem \</span><br><span class="line"></span><br><span class="line">	  </span><br><span class="line">[root@node-22 bin]# chmod +x kube-apiserver.sh</span><br></pre></td></tr></table></figure>

<p>配置supervisor守护</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 bin]# vim /etc/supervisord.d/kube-apiserver.ini</span><br></pre></td></tr></table></figure>

<p>kube-apiserver.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:kube-apiserver-7-22]</span></span><br><span class="line"><span class="attr">command</span>=/opt/kubernetes/server/bin/kube-apiserver.sh            <span class="comment">; the program (relative uses PATH, can take args)</span></span><br><span class="line"><span class="attr">numprocs</span>=<span class="number">1</span>                                                      <span class="comment">; number of processes copies to start (def 1)</span></span><br><span class="line"><span class="attr">directory</span>=/opt/kubernetes/server/bin                            <span class="comment">; directory to cwd to before exec (def no cwd)</span></span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span>                                                  <span class="comment">; start at supervisord start (default: true)</span></span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span>                                                <span class="comment">; retstart at unexpected quit (default: true)</span></span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">30</span>                                                    <span class="comment">; number of secs prog must stay running (def. 1)</span></span><br><span class="line"><span class="attr">startretries</span>=<span class="number">3</span>                                                  <span class="comment">; max # of serial start failures (default 3)</span></span><br><span class="line"><span class="attr">exitcodes</span>=<span class="number">0</span>,<span class="number">2</span>                                                   <span class="comment">; 'expected' exit codes for process (default 0,2)</span></span><br><span class="line"><span class="attr">stopsignal</span>=QUIT                                                 <span class="comment">; signal used to kill process (default TERM)</span></span><br><span class="line"><span class="attr">stopwaitsecs</span>=<span class="number">10</span>                                                 <span class="comment">; max num secs to wait b4 SIGKILL (default 10)</span></span><br><span class="line"><span class="attr">user</span>=root                                                       <span class="comment">; setuid to this UNIX account to run the program</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span>                                            <span class="comment">; redirect proc stderr to stdout (default false)</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        <span class="comment">; stderr log path, NONE for none; default AUTO</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">64</span>MB                                    <span class="comment">; max # logfile bytes b4 rotation (default 50MB)</span></span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">4</span>                                        <span class="comment">; # of stdout logfile backups (default 10)</span></span><br><span class="line"><span class="attr">stdout_capture_maxbytes</span>=<span class="number">1</span>MB                                     <span class="comment">; number of bytes in 'capturemode' (default 0)</span></span><br><span class="line"><span class="attr">stdout_events_enabled</span>=<span class="literal">false</span>                                     <span class="comment">; emit events on stdout writes (default false)</span></span><br><span class="line"><span class="attr">killasgroup</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stopasgroup</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>创建日志目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 bin]# mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 bin]# supervisorctl update</span><br><span class="line">kube-apiserver-7-22: added process group</span><br><span class="line"></span><br><span class="line">[root@node-22 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-22                 RUNNING   pid 6448, uptime 4:05:18</span><br><span class="line">kube-apiserver-7-22              RUNNING   pid 6671, uptime 0:00:32</span><br></pre></td></tr></table></figure>

<p>注：新版本的kube-apiserv 已经强制关闭了监听 http的 8080 端口，只能提供基于SSL的6443端口服务，我降版本重新安装了 v-1.19.11就可以配置 –insecure-port 8080 了。</p>
<h5 id="安装部署主控节点L4反代"><a href="#安装部署主控节点L4反代" class="headerlink" title="安装部署主控节点L4反代"></a>安装部署主控节点L4反代</h5><p>在  10.4.7.200 ( master) 和 10 .4.7.11(dns) 上安装 nginx（详见上文：安装nginx）</p>
<h6 id="安装配置nginx"><a href="#安装配置nginx" class="headerlink" title="安装配置nginx"></a>安装配置nginx</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master-200 yum.repos.d]# vim /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">[root@node-11 yum.repos.d]# vim /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

<p>统一配置 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">     upstream kube-apiserver &#123;</span><br><span class="line">           server 10.4.7.22:6443    max_fails=3 fail_timeout=30s;</span><br><span class="line">           server 10.4.7.33:6443    max_fails=3 fail_timeout=30s;</span><br><span class="line">     &#125;</span><br><span class="line">     server &#123;</span><br><span class="line">         listen 7443;</span><br><span class="line">         proxy_connect_timeout 2s;</span><br><span class="line">         proxy_timeout 900s;</span><br><span class="line">         proxy_pass kube-apiserver;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 yum.repos.d]# systemctl start nginx</span><br><span class="line">[root@node-11 yum.repos.d]# systemctl enable nginx</span><br><span class="line"></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br><span class="line"></span><br><span class="line">[root@master-200 yum.repos.d]# systemctl start nginx</span><br><span class="line">[root@master-200 yum.repos.d]# systemctl enable nginx</span><br><span class="line"></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br></pre></td></tr></table></figure>

<h6 id=""><a href="#" class="headerlink" title=""></a></h6><h6 id="安装配置-keepalive"><a href="#安装配置-keepalive" class="headerlink" title="安装配置 keepalive"></a>安装配置 keepalive</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 yum.repos.d]# yum install keepalived -y</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node-11 yum.repos.d]# vim /etc/keepalived/check_port.sh</span><br><span class="line"></span><br><span class="line">[root@node-11 yum.repos.d]# chmod +x /etc/keepalived/check_port.sh</span><br></pre></td></tr></table></figure>

<p>#!/bin/bash<br>CHK_PORT=$1<br>if [ -n “$CHK_PORT” ];then<br>        PORT_PROCESS=<code>ss -lnt|grep $CHK_PORT|wc -l</code><br>        if [ $PORT_PROCESS -eq 0 ];then<br>                echo “Port $CHK_PORT Is Not Used,End.”<br>                exit 1<br>        fi<br>else<br>        echo “Check Port Cant Be Empty!”<br>fi</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">node</span><span class="title">-11</span> keepalived]<span class="comment"># vim  /etc/keepalived/keepalived.conf</span></span><br></pre></td></tr></table></figure>

<p>10.4.7.11上的keepalived配置</p>
<p>global_defs {<br>   router_id 10.4.7.11</p>
<p>}</p>
<p>vrrp_script chk_nginx {<br>    script “/etc/keepalived/check_port.sh 7443”<br>    interval 2<br>    weight -20<br>}</p>
<p>vrrp_instance VI_1 {<br>    state MASTER<br>    interface ens33<br>    virtual_router_id 251<br>    priority 100<br>    advert_int 1<br>    mcast_src_ip 10.4.7.11<br>    nopreempt   </p>
<p>authentication {<br>    auth_type PASS<br>    auth_pass 11111111<br>}<br>track_script {<br>     chk_nginx<br>}<br>virtual_ipaddress {<br>    10.4.7.110<br>}</p>
<p>}</p>
<p>10.4.7.200上的keepalived配置</p>
<p>global_defs {<br>   router_id 10.4.7.200</p>
<p>}</p>
<p>vrrp_script chk_nginx {<br>    script “/etc/keepalived/check_port.sh 7443”<br>    interval 2<br>    weight -20<br>}</p>
<p>vrrp_instance VI_1 {<br>    state BACKUP<br>    interface ens33<br>    virtual_router_id 251<br>    priority 90<br>    advert_int 1<br>    mcast_src_ip 10.4.7.200</p>
<p>authentication {<br>    auth_type PASS<br>    auth_pass 11111111<br>}<br>track_script {<br>     chk_nginx<br>}<br>virtual_ipaddress {<br>    10.4.7.110<br>}</p>
<p>}</p>
<h5 id="安装-kube-controller-manager和kube-scheduler"><a href="#安装-kube-controller-manager和kube-scheduler" class="headerlink" title="安装 kube-controller-manager和kube-scheduler"></a>安装 kube-controller-manager和kube-scheduler</h5><p>controller启动脚本配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vim kube-controller-manager.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">./kube-controller-manager        \</span><br><span class="line">        --cluster-cidr 172.7.0.0/16     \</span><br><span class="line">        --log-dir /data/logs/kubernetes/kube-controller-manager         \</span><br><span class="line">        --master http://127.0.0.1:8080  \</span><br><span class="line">        --service-account-private-key-file ./cert/ca-key.pem    \</span><br><span class="line">        --service-cluster-ip-range 192.168.0.0/16       \</span><br><span class="line">         --root-ca-file ./cert/ca.pem   \</span><br><span class="line">         --v 2</span><br><span class="line"></span><br><span class="line">mkdir -p /data/logs/kubernetes/kube-controller-manager</span><br><span class="line"></span><br><span class="line">vim /etc/supervisord.d/kube-conntroller-manager.ini</span><br><span class="line"></span><br><span class="line">[program:kube-controller-manager-7-22]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br></pre></td></tr></table></figure>



<p>scheduler启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kube-scheduler \</span><br><span class="line">        --leader-elect  \</span><br><span class="line">        --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">        --master http://127.0.0.1:8080 \</span><br><span class="line">        --v 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line"></span><br><span class="line">mkdir -p /data/logs/kubernetes/kube-scheduler</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/supervisord.d/kube-scheduler.ini</span><br><span class="line"></span><br><span class="line">[program:kube-scheduler-7-22]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                            ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                              ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                              ; emit events on stdout writes (default false</span><br></pre></td></tr></table></figure>



<p>supervisor更新启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">supervisor update</span><br><span class="line">supervisor reload</span><br><span class="line">supervisorctl status</span><br><span class="line"></span><br><span class="line">tail -fn 200 /data/logs/etcd-server/etcd.stdout.log</span><br></pre></td></tr></table></figure>


<p>建立快速命令链接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span><br></pre></td></tr></table></figure>

<p>查看集群健康状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br></pre></td></tr></table></figure>

<h5 id="计算节点安装kubelet"><a href="#计算节点安装kubelet" class="headerlink" title="计算节点安装kubelet"></a>计算节点安装kubelet</h5><h6 id="证书签发-1"><a href="#证书签发-1" class="headerlink" title="证书签发"></a>证书签发</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# vim  kubelet-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "CN": "k8s-kubelet",</span><br><span class="line">    "hosts": [</span><br><span class="line">    "127.0.0.1",</span><br><span class="line">    "10.4.7.100",</span><br><span class="line">    "10.4.7.110",</span><br><span class="line">    "10.4.7.200",</span><br><span class="line">    "10.4.7.22",</span><br><span class="line">    "10.4.7.33",</span><br><span class="line">    "10.4.7.44",</span><br><span class="line">    "10.4.7.55",</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "chengdu",</span><br><span class="line">            "L": "chengdu",</span><br><span class="line">            "O": "Da",</span><br><span class="line">            "OU": "rifo"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node-100 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssljson -bare kubelet</span><br></pre></td></tr></table></figure>

<h6 id="拷贝证书到计算节点"><a href="#拷贝证书到计算节点" class="headerlink" title="拷贝证书到计算节点"></a>拷贝证书到计算节点</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/kubernetes/server/bin/cert</span><br><span class="line"></span><br><span class="line">scp node7-100.host.com:/opt/certs/kubelet.pem .</span><br><span class="line">scp node7-100.host.com:/opt/certs/kubelet-key.pem .</span><br></pre></td></tr></table></figure>

<h6 id="分发配置证书"><a href="#分发配置证书" class="headerlink" title="分发配置证书"></a>分发配置证书</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/kubernetes/server/bin/conf/</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster darifo-k8s \</span><br><span class="line">    --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=https://10.4.7.110:7443 \</span><br><span class="line">    --kubeconfig=kubelet.kubeconfig</span><br><span class="line">    </span><br><span class="line">kubectl config set-credentials k8s-node \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig </span><br><span class="line">  </span><br><span class="line">kubectl config set-context darifo-k8s-context \</span><br><span class="line">  --cluster=darifo-k8s \</span><br><span class="line">  --user=k8s-node \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context darifo-k8s-context --kubeconfig=kubelet.kubeconfig</span><br></pre></td></tr></table></figure>


<h6 id="集群角色绑定和权限授予"><a href="#集群角色绑定和权限授予" class="headerlink" title="集群角色绑定和权限授予"></a>集群角色绑定和权限授予</h6><p>计算节点 10.4.7.22 和 10.4.7.33 上：</p>
<p>k8s-node.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/conf</span><br><span class="line"></span><br><span class="line">vim k8s-node.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-node</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:node</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-node</span></span><br></pre></td></tr></table></figure>



<p>只需要在一个计算节点执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f k8s-node.yaml</span><br><span class="line"></span><br><span class="line">kubectl get clusterrolebinding k8s-node -o yaml</span><br></pre></td></tr></table></figure>

<h6 id="准备pause基础镜像"><a href="#准备pause基础镜像" class="headerlink" title="准备pause基础镜像"></a>准备pause基础镜像</h6><p>在管理运维节点 10.4.7.100上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker pull kubernetes/pause</span><br><span class="line"></span><br><span class="line">docker login harbor.zrf.com</span><br><span class="line"></span><br><span class="line">docker tag f9d5de079539 harbor.zrf.com/base-repo/pause:latest</span><br><span class="line"></span><br><span class="line">docker push harbor.zrf.com/base-repo/pause:latest</span><br></pre></td></tr></table></figure>


<h6 id="kubelet启动脚本"><a href="#kubelet启动脚本" class="headerlink" title="kubelet启动脚本"></a>kubelet启动脚本</h6><p>在计算节点上: /opt/kubernetes/server/bin</p>
<p>[root@node-22 bin]# vim kubelet.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kubelet \</span><br><span class="line">      --anonymous-auth=false \</span><br><span class="line">      --cgroup-driver systemd \</span><br><span class="line">	--cluster-dns 192.168.0.2 \</span><br><span class="line">	--cluster-domain cluster.local \</span><br><span class="line">	--runtime-cgroups=/systemd/system.slice \</span><br><span class="line">	--kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">	--fail-swap-on="false" \</span><br><span class="line">	--client-ca-file ./cert/ca.pem \</span><br><span class="line">	--tls-cert-file ./cert/kubelet.pem \</span><br><span class="line"> 	--tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">	--hostname-override node7-22.host.com \</span><br><span class="line">	--kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">	--log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">	--pod-infra-container-image harbor.zrf.com/base-repo/pause:latest \</span><br><span class="line">	--root-dir /data/kubelet</span><br></pre></td></tr></table></figure>

<p>[root@node-33 bin]# vim kubelet.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kubelet \</span><br><span class="line">    --anonymous-auth=false \</span><br><span class="line">    --cgroup-driver systemd \</span><br><span class="line">	--cluster-dns 192.168.0.2 \</span><br><span class="line">	--cluster-domain cluster.local \</span><br><span class="line">	--runtime-cgroups=/systemd/system.slice \</span><br><span class="line">	--kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">	--fail-swap-on="false" \</span><br><span class="line">	--client-ca-file ./cert/ca.pem \</span><br><span class="line">	--tls-cert-file ./cert/kubelet.pem \</span><br><span class="line"> 	--tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">	--hostname-override node7-33.host.com \</span><br><span class="line">	--kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">	--log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">	--pod-infra-container-image harbor.zrf.com/base-repo/pause:latest \</span><br><span class="line">	--root-dir /data/kubelet</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span><br><span class="line">chmod +x /opt/kubernetes/server/bin/kubelet.sh</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 bin]# vim /etc/supervisord.d/kube-kubelet.ini</span><br><span class="line"></span><br><span class="line">[program:kube-kubelet-7-22]	</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              		          ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                     ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                       ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node-33 bin]# vim /etc/supervisord.d/kube-kubelet.ini</span><br><span class="line"></span><br><span class="line">[program:kube-kubelet-7-33]	</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              		          ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                     ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                       ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 备注：当启动失败时，查看报错日志 </span></span><br><span class="line">tail -fn 200 /data/logs/kubernetes/kube-kubelet/kubelet.stdout.log</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-22                 RUNNING   pid 2255, uptime 4:06:42</span><br><span class="line">kube-apiserver-7-22              RUNNING   pid 2269, uptime 4:05:34</span><br><span class="line">kube-controller-manager-7-22     RUNNING   pid 2417, uptime 2:29:12</span><br><span class="line">kube-kubelet-7-22                RUNNING   pid 2585, uptime 0:00:30</span><br><span class="line">kube-scheduler-7-22              RUNNING   pid 2494, uptime 1:38:56</span><br><span class="line">[root@node-22 bin]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE   VERSION</span><br><span class="line">node7-22.host.com   Ready    &lt;none&gt;   71s   v1.19.11</span><br><span class="line">node7-33.host.com   Ready    &lt;none&gt;   74s   v1.19.11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-33 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-33                 RUNNING   pid 2136, uptime 4:06:05</span><br><span class="line">kube-apiserver-7-33              RUNNING   pid 2149, uptime 4:05:02</span><br><span class="line">kube-controller-manager-7-33     RUNNING   pid 2290, uptime 1:38:52</span><br><span class="line">kube-kubelet-7-33                RUNNING   pid 2393, uptime 0:00:31</span><br><span class="line">kube-scheduler-7-33              RUNNING   pid 2052, uptime 4:12:01</span><br><span class="line">[root@node-33 bin]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE    VERSION</span><br><span class="line">node7-22.host.com   Ready    &lt;none&gt;   117s   v1.19.11</span><br><span class="line">node7-33.host.com   Ready    &lt;none&gt;   2m     v1.19.11</span><br></pre></td></tr></table></figure>

<p>节点角色添加标签</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 给节点 node7-22.host.com 添加一个master标签</span></span><br><span class="line">kubectl label node node7-22.host.com node-role.kubernetes.io/master=</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 给节点 node7-33.host.com 添加一个 node 标签</span></span><br><span class="line">kubectl label node node7-33.host.com node-role.kubernetes.io/node=</span><br><span class="line"></span><br><span class="line">[root@node-22 bin]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE     VERSION</span><br><span class="line">node7-22.host.com   Ready    master   7m30s   v1.19.11</span><br><span class="line">node7-33.host.com   Ready    node     7m33s   v1.19.11</span><br></pre></td></tr></table></figure>

<h5 id="计算节点安装kube-proxy"><a href="#计算节点安装kube-proxy" class="headerlink" title="计算节点安装kube-proxy"></a>计算节点安装kube-proxy</h5><h6 id="签发证书"><a href="#签发证书" class="headerlink" title="签发证书"></a>签发证书</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# vim kube-proxy-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "CN": "system:kube-proxy",</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "Da",</span><br><span class="line">            "OU": "rifo"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-100 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssljson -bare kube-proxy-client</span><br></pre></td></tr></table></figure>

<h6 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h6><p>在计算节点： /opt/kubernetes/server/bin/cert</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp node7-100.host.com:/opt/certs/kube-proxy-client.pem .</span><br><span class="line">scp node7-100.host.com:/opt/certs/kube-proxy-client-key.pem .</span><br></pre></td></tr></table></figure>

<h6 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h6><p>在 节点 22 上：</p>
<p>/opt/kubernetes/server/bin/conf 目录内执行</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-cluster darifo-k8s \</span><br><span class="line"> <span class="attribute">--certificate-authority</span>=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line"> <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line"> <span class="attribute">--server</span>=https://10.4.7.110:7443 \</span><br><span class="line"> <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-credentials kube-proxy \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-context darifo-k8s-context \</span><br><span class="line">  <span class="attribute">--cluster</span>=darifo-k8s \</span><br><span class="line">  <span class="attribute">--user</span>=kube-proxy \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>use-context darifo-k8s-context <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>拷贝到 33 节点</p>
<p>/opt/kubernetes/server/bin/conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-33 cert]# scp node7-22.host.com:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig .</span><br></pre></td></tr></table></figure>

<h6 id="安装配置IPVS"><a href="#安装配置IPVS" class="headerlink" title="安装配置IPVS"></a>安装配置IPVS</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vi /root/ipvs.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ipvs_mods_dir="/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs"</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o "^[^.]*")</span><br><span class="line">do</span><br><span class="line">  /sbin/modinfo -F filename $i &amp;&gt;/dev/null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    /sbin/modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">chmod u+x /root/ipvs.sh</span><br><span class="line"></span><br><span class="line">cd ~</span><br><span class="line"></span><br><span class="line">./ipvs.sh</span><br></pre></td></tr></table></figure>

<p>查看ipvs模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 ~]# lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line">ip_vs_wrr              12697  0 </span><br><span class="line">ip_vs_wlc              12519  0 </span><br><span class="line">ip_vs_sh               12688  0 </span><br><span class="line">ip_vs_sed              12519  0 </span><br><span class="line">ip_vs_rr               12600  0 </span><br><span class="line">ip_vs_pe_sip           12740  0 </span><br><span class="line">nf_conntrack_sip       33780  1 ip_vs_pe_sip</span><br><span class="line">ip_vs_nq               12516  0 </span><br><span class="line">ip_vs_lc               12516  0 </span><br><span class="line">ip_vs_lblcr            12922  0 </span><br><span class="line">ip_vs_lblc             12819  0 </span><br><span class="line">ip_vs_ftp              13079  0 </span><br><span class="line">ip_vs_dh               12688  0 </span><br><span class="line">ip_vs                 145458  24 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_pe_sip,ip_vs_lblcr,ip_vs_lblc</span><br><span class="line">nf_nat                 26583  3 ip_vs_ftp,nf_nat_ipv4,nf_nat_masquerade_ipv4</span><br><span class="line">nf_conntrack          139264  8 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_sip,nf_conntrack_ipv4</span><br><span class="line">libcrc32c              12644  4 xfs,ip_vs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>

<h6 id="创建kube-proxy启动脚本"><a href="#创建kube-proxy启动脚本" class="headerlink" title="创建kube-proxy启动脚本"></a>创建kube-proxy启动脚本</h6><p>计算节点都需要操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kube-proxy.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --hostname-override node7-22.host.com \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line">chmod +x kube-proxy.sh</span><br><span class="line"></span><br><span class="line">mkdir -p /data/logs/kubernetes/kube-proxy</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/supervisord.d/kube-proxy.ini</span><br><span class="line"></span><br><span class="line">[program:kube-proxy-7-22]</span><br><span class="line"><span class="attribute">command</span>=/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line"><span class="attribute">numprocs</span>=1                                                           ; number of processes copies <span class="keyword">to</span> start (def 1)</span><br><span class="line"><span class="attribute">directory</span>=/opt/kubernetes/server/bin                                 ; directory <span class="keyword">to</span> cwd <span class="keyword">to</span> before exec (def <span class="literal">no</span> cwd)</span><br><span class="line"><span class="attribute">autostart</span>=<span class="literal">true</span>                                                       ; start at supervisord start (default: <span class="literal">true</span>)</span><br><span class="line"><span class="attribute">autorestart</span>=<span class="literal">true</span>                                                     ; retstart at unexpected quit (default: <span class="literal">true</span>)</span><br><span class="line"><span class="attribute">startsecs</span>=30                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line"><span class="attribute">startretries</span>=3                                                       ; max # of serial start failures (default 3)</span><br><span class="line"><span class="attribute">exitcodes</span>=0,2                                                        ; <span class="string">'expected'</span> exit codes <span class="keyword">for</span> process (default 0,2)</span><br><span class="line"><span class="attribute">stopsignal</span>=QUIT                                                      ; signal used <span class="keyword">to</span> kill process (default TERM)</span><br><span class="line"><span class="attribute">stopwaitsecs</span>=10                                                      ; max num secs <span class="keyword">to</span> wait b4 SIGKILL (default 10)</span><br><span class="line"><span class="attribute">user</span>=root                                                            ; setuid <span class="keyword">to</span> this UNIX account <span class="keyword">to</span> <span class="builtin-name">run</span> the program</span><br><span class="line"><span class="attribute">redirect_stderr</span>=<span class="literal">true</span>                                                 ; redirect proc stderr <span class="keyword">to</span> stdout (default <span class="literal">false</span>)</span><br><span class="line"><span class="attribute">stdout_logfile</span>=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE <span class="keyword">for</span> none;<span class="built_in"> default </span>AUTO</span><br><span class="line"><span class="attribute">stdout_logfile_maxbytes</span>=64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line"><span class="attribute">stdout_logfile_backups</span>=4                                             ; # of stdout logfile backups (default 10)</span><br><span class="line"><span class="attribute">stdout_capture_maxbytes</span>=1MB                                          ; number of bytes <span class="keyword">in</span> <span class="string">'capturemode'</span> (default 0)</span><br><span class="line"><span class="attribute">stdout_events_enabled</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">supervisorctl</span> <span class="string">update</span></span><br><span class="line"><span class="attr">supervisorctl</span> <span class="string">status</span></span><br></pre></td></tr></table></figure>

<p>创建 nginx pod 验证集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 ~]# vim nginx-test.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-darifo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>  <span class="comment">#Pod的副本数量，多节点实现负载均衡与高可用</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">harbor.zrf.com/base-repo/nginx:v1.20</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>


<p>验证查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node-22 ~]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;"health":"true"&#125;   </span><br><span class="line">[root@node-22 ~]# kubectl get pods</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-darifo-686ccbfff7-9q2c8   1/1     Running   0          10m</span><br><span class="line">nginx-darifo-686ccbfff7-md9fs   1/1     Running   0          10m</span><br><span class="line">nginx-darifo-686ccbfff7-xq9cg   1/1     Running   0          10m</span><br><span class="line">[root@node-22 ~]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE    VERSION</span><br><span class="line">node7-22.host.com   Ready    master   132m   v1.19.11</span><br><span class="line">node7-33.host.com   Ready    node     132m   v1.19.11</span><br></pre></td></tr></table></figure>

<h5 id="通过Service暴露服务"><a href="#通过Service暴露服务" class="headerlink" title="通过Service暴露服务"></a>通过Service暴露服务</h5><p>暴露服务的三种方式<br>NodePort<br>将服务的类型设置成NodePort-每个集群节点都会在节点上打 开 一<br>个端口， 对于NodePort服务， 每个集群节点在节点本身（因此得名叫<br>NodePort)上打开一个端口，并将在该端口上接收到的流量重定向到基础服务。<br>该服务仅在内部集群 IP 和端口上才可访间， 但也可通过所有节点上的专用端<br>口访问。<br>LoadBalane<br>将服务的类型设置成LoadBalance, NodePort类型的一 种扩展，这使得<br>服务可以通过一个专用的负载均衡器来访问， 这是由Kubernetes中正在运行<br>的云基础设施提供的。 负载均衡器将流量重定向到跨所有节点的节点端口。<br>客户端通过负载均衡器的 IP 连接到服务。<br>Ingress<br>创建一 个Ingress资源， 这是一 个完全不同的机制， 通过一 个IP地址公开多<br>个服务,就是一个网关入口，和springcloud的网关zuul、gateway类似。</p>
<p>编写服务yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-darifo-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">		<span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">		<span class="attr">nodePort:</span> <span class="number">18080</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">nginx-darifo</span></span><br></pre></td></tr></table></figure>

<p>外部访问</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//node7-33.host.com:18080/</span></span><br></pre></td></tr></table></figure>



<h5 id="基础组件安装总结"><a href="#基础组件安装总结" class="headerlink" title="基础组件安装总结"></a>基础组件安装总结</h5><p>DNS节点：安装了bind9自建的DNS服务、Nginx服务及反代</p>
<p>运维管理节点：进行证书CA签发、Harbor镜像仓库私服</p>
<p>主节点：Etcd服务、Nginx服务、keepalived</p>
<p>计算节点：etcd服务、supervisor、kube-apiserver组件、kube-controller-manager组件、kubelet组件、kube-scheduler组件、kube-proxy组件、IPVS</p>
<blockquote>
<p>路漫漫其修远兮，吾将上下而求索！</p>
</blockquote>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/K8S/" rel="tag"># K8S</a>
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
            <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" rel="tag"># 软件安装</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/19/Jenkins-Docker-Gitlab-%E5%AE%9E%E7%8E%B0%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%EF%BC%881%EF%BC%89/" rel="next" title="Jenkins + Docker + Gitlab 实现持续集成自动部署（1）">
                <i class="fa fa-chevron-left"></i> Jenkins + Docker + Gitlab 实现持续集成自动部署（1）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Darifo" />
            
              <p class="site-author-name" itemprop="name">Darifo</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/darifo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:feaglenet@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-globe"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.darifo.xyz/" title="Darifo`s Blog" target="_blank">Darifo`s Blog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装虚拟机软件VMware"><span class="nav-number">1.</span> <span class="nav-text">安装虚拟机软件VMware</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建准备Linux虚拟机环境"><span class="nav-number">2.</span> <span class="nav-text">创建准备Linux虚拟机环境</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#下载系统镜像"><span class="nav-number">2.1.</span> <span class="nav-text">下载系统镜像</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建虚拟机"><span class="nav-number">2.2.</span> <span class="nav-text">创建虚拟机</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#制作模板机"><span class="nav-number">2.3.</span> <span class="nav-text">制作模板机</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#根据模板机克隆至少5个虚拟机"><span class="nav-number">2.4.</span> <span class="nav-text">根据模板机克隆至少5个虚拟机</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#网络规划和配置"><span class="nav-number">3.</span> <span class="nav-text">网络规划和配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#虚拟机网络（服务器网络）"><span class="nav-number">3.1.</span> <span class="nav-text">虚拟机网络（服务器网络）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#服务器1（主节点Master）"><span class="nav-number">3.1.1.</span> <span class="nav-text">服务器1（主节点Master）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#服务器2（管理运维节点Manager）"><span class="nav-number">3.1.2.</span> <span class="nav-text">服务器2（管理运维节点Manager）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#服务器3（DNS节点）"><span class="nav-number">3.1.3.</span> <span class="nav-text">服务器3（DNS节点）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#服务器4（计算节点1）"><span class="nav-number">3.1.4.</span> <span class="nav-text">服务器4（计算节点1）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#服务器5（计算节点2）"><span class="nav-number">3.1.5.</span> <span class="nav-text">服务器5（计算节点2）</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#系统配置"><span class="nav-number">3.2.</span> <span class="nav-text">系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#更改主机名"><span class="nav-number">3.2.1.</span> <span class="nav-text">更改主机名</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭防火墙-firewalld"><span class="nav-number">4.</span> <span class="nav-text">关闭防火墙 firewalld</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭SELinux"><span class="nav-number">5.</span> <span class="nav-text">关闭SELinux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭SWAP"><span class="nav-number">6.</span> <span class="nav-text">关闭SWAP</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#禁用-proc-swaps-中的所有交换区"><span class="nav-number">6.0.1.</span> <span class="nav-text">禁用 &#x2F;proc&#x2F;swaps 中的所有交换区</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#注释掉-swap-相关配置"><span class="nav-number">6.0.2.</span> <span class="nav-text">注释掉 swap 相关配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#确保成功-列表为空"><span class="nav-number">6.0.3.</span> <span class="nav-text">确保成功 列表为空</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装容器运行时（Docker）"><span class="nav-number">7.</span> <span class="nav-text">安装容器运行时（Docker）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#更新yum软件包"><span class="nav-number">7.0.1.</span> <span class="nav-text">更新yum软件包</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安装基础依赖"><span class="nav-number">7.0.2.</span> <span class="nav-text">安装基础依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#添加-Docker-yum阿里云仓库"><span class="nav-number">7.0.3.</span> <span class="nav-text">添加 Docker yum阿里云仓库</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安装docker-ce"><span class="nav-number">7.0.4.</span> <span class="nav-text">安装docker-ce</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#配置Docker-daemon"><span class="nav-number">7.0.5.</span> <span class="nav-text">配置Docker daemon</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#重载配置和重启docker设置开机启动"><span class="nav-number">7.0.6.</span> <span class="nav-text">重载配置和重启docker设置开机启动</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#克隆系统镜像"><span class="nav-number">8.</span> <span class="nav-text">克隆系统镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DNS节点安装bind服务"><span class="nav-number">9.</span> <span class="nav-text">DNS节点安装bind服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#证书签发"><span class="nav-number">10.</span> <span class="nav-text">证书签发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装Harbor"><span class="nav-number">11.</span> <span class="nav-text">安装Harbor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-K8s"><span class="nav-number">12.</span> <span class="nav-text">安装 K8s</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#master节点（10-4-7-200）安装etcd"><span class="nav-number">12.1.</span> <span class="nav-text">master节点（10.4.7.200）安装etcd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#计算节点1（10-4-7-22）安装etcd"><span class="nav-number">12.2.</span> <span class="nav-text">计算节点1（10.4.7.22）安装etcd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#计算节点2（10-4-7-33）安装etcd"><span class="nav-number">12.3.</span> <span class="nav-text">计算节点2（10.4.7.33）安装etcd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下载安装-kubernetes"><span class="nav-number">12.4.</span> <span class="nav-text">下载安装 kubernetes</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#计算节点1（10-4-7-22）安装k8s"><span class="nav-number">12.4.1.</span> <span class="nav-text">计算节点1（10.4.7.22）安装k8s</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#计算节点1（10-4-7-33）安装k8s"><span class="nav-number">12.4.2.</span> <span class="nav-text">计算节点1（10.4.7.33）安装k8s</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#签发k8s证书"><span class="nav-number">12.5.</span> <span class="nav-text">签发k8s证书</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#将证书拷贝到各个计算节点"><span class="nav-number">12.6.</span> <span class="nav-text">将证书拷贝到各个计算节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建-apiserver启动配置文件"><span class="nav-number">12.7.</span> <span class="nav-text">创建 apiserver启动配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装部署主控节点L4反代"><span class="nav-number">12.8.</span> <span class="nav-text">安装部署主控节点L4反代</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#安装配置nginx"><span class="nav-number">12.8.1.</span> <span class="nav-text">安装配置nginx</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#"><span class="nav-number">12.8.2.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安装配置-keepalive"><span class="nav-number">12.8.3.</span> <span class="nav-text">安装配置 keepalive</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装-kube-controller-manager和kube-scheduler"><span class="nav-number">12.9.</span> <span class="nav-text">安装 kube-controller-manager和kube-scheduler</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#计算节点安装kubelet"><span class="nav-number">12.10.</span> <span class="nav-text">计算节点安装kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#证书签发-1"><span class="nav-number">12.10.1.</span> <span class="nav-text">证书签发</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#拷贝证书到计算节点"><span class="nav-number">12.10.2.</span> <span class="nav-text">拷贝证书到计算节点</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#分发配置证书"><span class="nav-number">12.10.3.</span> <span class="nav-text">分发配置证书</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#集群角色绑定和权限授予"><span class="nav-number">12.10.4.</span> <span class="nav-text">集群角色绑定和权限授予</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#准备pause基础镜像"><span class="nav-number">12.10.5.</span> <span class="nav-text">准备pause基础镜像</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#kubelet启动脚本"><span class="nav-number">12.10.6.</span> <span class="nav-text">kubelet启动脚本</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#计算节点安装kube-proxy"><span class="nav-number">12.11.</span> <span class="nav-text">计算节点安装kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#签发证书"><span class="nav-number">12.11.1.</span> <span class="nav-text">签发证书</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#分发证书"><span class="nav-number">12.11.2.</span> <span class="nav-text">分发证书</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#创建配置"><span class="nav-number">12.11.3.</span> <span class="nav-text">创建配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安装配置IPVS"><span class="nav-number">12.11.4.</span> <span class="nav-text">安装配置IPVS</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#创建kube-proxy启动脚本"><span class="nav-number">12.11.5.</span> <span class="nav-text">创建kube-proxy启动脚本</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过Service暴露服务"><span class="nav-number">12.12.</span> <span class="nav-text">通过Service暴露服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基础组件安装总结"><span class="nav-number">12.13.</span> <span class="nav-text">基础组件安装总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Darifo`s Blog</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
