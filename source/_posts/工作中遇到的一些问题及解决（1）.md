---
title: 工作中遇到的一些问题及解决（1）
categories: 
- 经验总结
tags:
- PHP
date: 2019-7-24 00:00:00
---

## 结算财务管理

> 以下问题不分时间先后

### 1

- 问题描述：

合同续约场景下，合同A结束，合同B开始，一笔订单：跨合同A结算期、合约期外、合同控制器、合同结算期四个阶段，订单提前离店日期分别在以上四个阶段之一，订单产生了一笔违约金，违约金结算规则是：离店日期所在的结算周期（订单结束日期+1 或者 提前离店日期（如果是））。考虑目前使用房态进行订单拆分结算操作，提前离店的订单，离店日期之后的部分不占房态；


- 涉及接口：

预结算、结算、直接结算


- 流程简述：

打款计划=》合同房源=》订单=》=》房态=》订单附加款

- 解决思路

拿到当期打款计划、房源合同信息，
获取包含在（部分或全部）周期内的订单，
判断：订单是否是提前离店（真实离店日期字段），
如果是，进一步判断拆分


### 2

结算及下载服务问题（20190704）

- 问题描述：

订单当天入住当天离店，被释放掉的房态位置又被新增的订单所占用。
在现有的结算明细表导出逻辑中，是按照以下流程操作的：


1、查询周期内所有房源的所有订单信息，存进数组，同时取出所有订单ID；

2、根据所有订单ID查询所有订单房态信息，存入数组；

3、遍历所有订单，根据订单ID，从2所有订单房态信息数组中，取出当前订单占的房态信息，如果取不出就置为空；

4、如果3没有拿到某笔订单占的房态信息，就默认给一个日期是 2018-01-01和2018-01-02；
所以，导出的部分订单的日期就显示为固定的 2018-01-01 到 2018-01-02 ，定位为这些订单均是当天入住当天离店的特殊情况。


- 解决方案：

取这笔特殊订单本身的开始日期、结束日期+1，代替其所占房态上的入住和离店日期导出。


- 解决过程中遇到的坑：

「改错代码文件」因为涉及的代码在之前做过迭代优化，保留了几个旧版本的文件，文件名非常相似，内容几乎一样，随着时间推移，渐渐忘记当前业务使用的是哪一个代码文件，故造成改错文件，从而导致提测试一直不通过。

因此，在之后的开发中，多版本的代码文件，文件名要按照一定规范加上时间或版本。


### 3

C端问题（20190703）

- 问题描述：

现有一笔跨结算周期的长订单（2019-06-26 —— 2019-07-08），结算前被取消，订单产生了一笔违约金，按照结算逻辑（订单产生的违约金要被结算，结算时间约定为该笔订单的离店日期所在的结算周期内），故该笔订单产生的违约金应该在7月份的周期被结算。由于C端后台处理这笔订单违约金时，没有约束其结算周期，即将该笔订单产生的违约金读出算入了6月一期的预计收入里面，与PC端显示的数据没有保持一致性，不影响结算结果。


- 解决方案：

修复此处的违约金处理规则，通过订单的离店日期和打款计划日期区间，确定是否参与到当期的计算公式中。

判断条件：

当期打款开始日期 <= 订单离店日期 <= 当期打款结束日期


### 4

结算问题（20190702）

- 问题：

1、调账表格导入数据逻辑重复问题；

说明：同一概念的数据允许被多次写入数据表。

2、数据格式（调整日期）校验及结算查询条件问题；

说明：原格式 2019-05-01 变成了 2019-06-02 ，接口查询条件是约定的每月1号，导入的时候变成了2号，在结算的时候，查询不到指定的调账数据。

- 解决问题：

1、加强表格导入格式和数据内容的校验；

2、增加删除调账记录的功能；

3、优化结算调账查询条件，排除只能查 2019-06-01 这种情况，而是查询整个 2019-06 这一期的数据；


- 预期目标：

不出现逻辑意义的重复数据；

能够删除或者批量删除列表数据；


- 其他：

增加修改功能；


### 5

结算问题（2019.06.03）

- 问题产生：

X房子在明细中有订单，分成中没有
明细中这笔订单是一笔跨月的，跨上个月的和这个月的
明细里面的订单编号是（*****）


- 问题查找步骤：

1、通过合同no到contract表查询合同ID

2、通过合同ID到contracthouse查询房源ID

3、通过房源ID、日期区间查询房态数据

4、通过房源ID、日期区间查询订单数据

5、通过合同ID、日期区间查询结算单数据

- 分析问题：

查询出来的结算单里面金额为0，判断当期的结算并没有结算到订单数据；

查询出来的订单数据，判断该订单是跨周期的订单，2019.04.28—2019.05.05，跨越了4月和5月，订单金额正常，订单状态已离店；

查询出来的房态数据里面有对应订单的部分，也就是5月的01、02、03、04、05共5天，正常，但是房态结算标记为未结算状态；

- 尝试操作：

驳回结算，重新结算，再查看未结算列表，查看详情，该房源当期可结算订单数据查询正常；


- 结论：

结算订单状态错乱，导致首次结算时没有查询出该笔订单未结算；


### 6

